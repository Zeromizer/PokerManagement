<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poker Management App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-analytics-compat.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding-top: 20px;
      background-color: #f8f9fa;
    }
    .navbar-brand {
      font-weight: 700;
      color: #2c3e50;
    }
    .card {
      margin-bottom: 20px;
      border: none;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .card-header {
      background-color: #2c3e50;
      color: white;
      font-weight: 600;
    }
    .btn-primary {
      background-color: #2c3e50;
      border-color: #2c3e50;
    }
    .btn-primary:hover {
      background-color: #1a252f;
      border-color: #1a252f;
    }
    .player-card {
      transition: all 0.3s;
    }
    .player-card:hover {
      transform: translateY(-5px);
    }
    #gameStatus {
      font-weight: 700;
      font-size: 1.2rem;
    }
    .timer {
      font-size: 1.5rem;
      font-weight: 700;
    }
    .blind-level {
      font-weight: 600;
    }
    #loginSection, #registerSection {
      max-width: 400px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
      <a class="navbar-brand" href="#">üÉè Poker Management</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="#" id="dashboardLink">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="playersLink">Players</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="gamesLink">Games</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="statsLink">Stats</a>
          </li>
        </ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item" id="loginNavItem">
            <a class="nav-link" href="#" id="loginLink">Login</a>
          </li>
          <li class="nav-item" id="registerNavItem">
            <a class="nav-link" href="#" id="registerLink">Register</a>
          </li>
          <li class="nav-item d-none" id="logoutNavItem">
            <a class="nav-link" href="#" id="logoutLink">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container mt-4">
    
    <!-- Auth Sections -->
    <div id="loginSection" class="d-none">
      <div class="card">
        <div class="card-header">Login</div>
        <div class="card-body">
          <div class="mb-3">
            <label for="loginEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="loginEmail">
          </div>
          <div class="mb-3">
            <label for="loginPassword" class="form-label">Password</label>
            <input type="password" class="form-control" id="loginPassword">
          </div>
          <button class="btn btn-primary" id="loginButton">Login</button>
          <p class="mt-3">Don't have an account? <a href="#" id="showRegisterLink">Register</a></p>
        </div>
      </div>
    </div>

    <div id="registerSection" class="d-none">
      <div class="card">
        <div class="card-header">Register</div>
        <div class="card-body">
          <div class="mb-3">
            <label for="registerName" class="form-label">Name</label>
            <input type="text" class="form-control" id="registerName">
          </div>
          <div class="mb-3">
            <label for="registerEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="registerEmail">
          </div>
          <div class="mb-3">
            <label for="registerPassword" class="form-label">Password</label>
            <input type="password" class="form-control" id="registerPassword">
          </div>
          <button class="btn btn-primary" id="registerButton">Register</button>
          <p class="mt-3">Already have an account? <a href="#" id="showLoginLink">Login</a></p>
        </div>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="d-none">
      <h2 class="mb-4">Welcome to Poker Management</h2>
      
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">Quick Actions</div>
            <div class="card-body">
              <button class="btn btn-primary mb-2 w-100" id="newGameButton">Start New Game</button>
              <button class="btn btn-outline-primary mb-2 w-100" id="addPlayerButton">Add New Player</button>
              <button class="btn btn-outline-primary w-100" id="viewStatsButton">View Game Stats</button>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">Recent Activity</div>
            <div class="card-body">
              <ul class="list-group" id="recentActivityList">
                <!-- Populated from Firebase -->
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header">Upcoming Games</div>
            <div class="card-body">
              <div id="upcomingGamesList">
                <!-- Populated from Firebase -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Players Section -->
    <div id="playersSection" class="d-none">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Players</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPlayerModal">Add Player</button>
      </div>
      
      <div class="row" id="playersList">
        <!-- Populated from Firebase -->
      </div>

      <!-- Add Player Modal -->
      <div class="modal fade" id="addPlayerModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Add New Player</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="playerName" class="form-label">Name</label>
                <input type="text" class="form-control" id="playerName">
              </div>
              <div class="mb-3">
                <label for="playerEmail" class="form-label">Email (optional)</label>
                <input type="email" class="form-control" id="playerEmail">
              </div>
              <div class="mb-3">
                <label for="playerPhone" class="form-label">Phone (optional)</label>
                <input type="tel" class="form-control" id="playerPhone">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="savePlayerButton">Save Player</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Games Section -->
    <div id="gamesSection" class="d-none">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Poker Games</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newGameModal">Start New Game</button>
      </div>
      
      <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
          <a class="nav-link active" id="activeGamesTab" href="#">Active</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="upcomingGamesTab" href="#">Upcoming</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="pastGamesTab" href="#">Past</a>
        </li>
      </ul>
      
      <div id="gamesList">
        <!-- Populated from Firebase -->
      </div>

      <!-- New Game Modal -->
      <div class="modal fade" id="newGameModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Start New Game</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="gameName" class="form-label">Game Name</label>
                    <input type="text" class="form-control" id="gameName">
                  </div>
                  <div class="mb-3">
                    <label for="gameDate" class="form-label">Date</label>
                    <input type="date" class="form-control" id="gameDate">
                  </div>
                  <div class="mb-3">
                    <label for="gameTime" class="form-label">Time</label>
                    <input type="time" class="form-control" id="gameTime">
                  </div>
                  <div class="mb-3">
                    <label for="gameLocation" class="form-label">Location</label>
                    <input type="text" class="form-control" id="gameLocation">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="gameType" class="form-label">Game Type</label>
                    <select class="form-select" id="gameType">
                      <option value="texas_holdem">Texas Hold'em</option>
                      <option value="omaha">Omaha</option>
                      <option value="seven_card_stud">Seven Card Stud</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="buyIn" class="form-label">Buy-in Amount ($)</label>
                    <input type="number" class="form-control" id="buyIn">
                  </div>
                  <div class="mb-3">
                    <label for="startingChips" class="form-label">Starting Chips</label>
                    <input type="number" class="form-control" id="startingChips">
                  </div>
                  <div class="mb-3">
                    <label for="blindStructure" class="form-label">Blind Structure</label>
                    <select class="form-select" id="blindStructure">
                      <option value="slow">Slow</option>
                      <option value="medium" selected>Medium</option>
                      <option value="fast">Fast</option>
                      <option value="custom">Custom</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Select Players</label>
                <div id="playerSelectionList" class="border p-3 rounded">
                  <!-- Populated from Firebase -->
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="saveGameButton">Start Game</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Active Game Section -->
    <div id="activeGameSection" class="d-none">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 id="activeGameName">Game Name</h2>
        <div>
          <span class="badge bg-success me-2" id="gameStatus">In Progress</span>
          <button class="btn btn-warning me-2" id="pauseGameButton">Pause</button>
          <button class="btn btn-danger" id="endGameButton">End Game</button>
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">Game Info</div>
            <div class="card-body">
              <div class="d-flex justify-content-between mb-3">
                <span>Current Level:</span>
                <span class="blind-level" id="currentLevel">1</span>
              </div>
              <div class="d-flex justify-content-between mb-3">
                <span>Blinds:</span>
                <span class="blind-level" id="currentBlinds">5/10</span>
              </div>
              <div class="d-flex justify-content-center mb-3">
                <span class="timer" id="levelTimer">15:00</span>
              </div>
              <button class="btn btn-primary w-100" id="nextLevelButton">Next Level</button>
              
              <hr>
              
              <div class="d-flex justify-content-between mb-2">
                <span>Buy-in:</span>
                <span id="gameBuyIn">$50</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>Players:</span>
                <span id="playerCount">0</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>Total Pot:</span>
                <span id="totalPot">$0</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <span>Players</span>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addPlayerToGameModal">Add Player</button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Player</th>
                      <th>Buy-in</th>
                      <th>Chips</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="activePlayersList">
                    <!-- Populated from Firebase -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row mt-4">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header">Game Log</div>
            <div class="card-body">
              <ul class="list-group" id="gameLogList">
                <!-- Populated from Firebase -->
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Add Player to Game Modal -->
      <div class="modal fade" id="addPlayerToGameModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Add Player to Game</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="gamePlayerSelect" class="form-label">Select Player</label>
                <select class="form-select" id="gamePlayerSelect">
                  <!-- Populated from Firebase -->
                </select>
              </div>
              <div class="mb-3">
                <label for="playerBuyIn" class="form-label">Buy-in Amount ($)</label>
                <input type="number" class="form-control" id="playerBuyIn">
              </div>
              <div class="mb-3">
                <label for="playerStartingChips" class="form-label">Starting Chips</label>
                <input type="number" class="form-control" id="playerStartingChips">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="addPlayerToGameButton">Add Player</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Rebuy Modal -->
      <div class="modal fade" id="rebuyModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Rebuy for <span id="rebuyPlayerName">Player</span></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="rebuyAmount" class="form-label">Rebuy Amount ($)</label>
                <input type="number" class="form-control" id="rebuyAmount">
              </div>
              <div class="mb-3">
                <label for="rebuyChips" class="form-label">Chips Received</label>
                <input type="number" class="form-control" id="rebuyChips">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="confirmRebuyButton">Confirm Rebuy</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Stats Section -->
    <div id="statsSection" class="d-none">
      <h2 class="mb-4">Statistics</h2>
      
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">Player Leaderboard</div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Rank</th>
                      <th>Player</th>
                      <th>Wins</th>
                      <th>Profit/Loss</th>
                    </tr>
                  </thead>
                  <tbody id="leaderboardList">
                    <!-- Populated from Firebase -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">Recent Games Summary</div>
            <div class="card-body">
              <div id="recentGamesList">
                <!-- Populated from Firebase -->
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row mt-4">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header">Game Statistics</div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-3 text-center mb-4">
                  <h5>Total Games</h5>
                  <div class="display-4" id="totalGamesCount">0</div>
                </div>
                <div class="col-md-3 text-center mb-4">
                  <h5>Total Players</h5>
                  <div class="display-4" id="totalPlayersCount">0</div>
                </div>
                <div class="col-md-3 text-center mb-4">
                  <h5>Avg Buy-in</h5>
                  <div class="display-4" id="avgBuyIn">$0</div>
                </div>
                <div class="col-md-3 text-center mb-4">
                  <h5>Largest Pot</h5>
                  <div class="display-4" id="largestPot">$0</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDSQMxkau0IQ1Jf1WIiW3kJWBNhOXVw39Y",
      authDomain: "poker-management-app-88833.firebaseapp.com",
      databaseURL: "https://poker-management-app-88833-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "poker-management-app-88833",
      storageBucket: "poker-management-app-88833.firebasestorage.app",
      messagingSenderId: "4050240829222",
      appId: "1:4050240829222:web:5f31f705c572b0930d4093",
      measurementId: "G-Q549YJDX94"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const analytics = firebase.analytics();

    // DOM Elements
    const sections = {
      login: document.getElementById('loginSection'),
      register: document.getElementById('registerSection'),
      dashboard: document.getElementById('dashboardSection'),
      players: document.getElementById('playersSection'),
      games: document.getElementById('gamesSection'),
      activeGame: document.getElementById('activeGameSection'),
      stats: document.getElementById('statsSection')
    };

    const navItems = {
      login: document.getElementById('loginNavItem'),
      register: document.getElementById('registerNavItem'),
      logout: document.getElementById('logoutNavItem')
    };

    // Navigation Links
    document.getElementById('dashboardLink').addEventListener('click', () => showSection('dashboard'));
    document.getElementById('playersLink').addEventListener('click', () => showSection('players'));
    document.getElementById('gamesLink').addEventListener('click', () => showSection('games'));
    document.getElementById('statsLink').addEventListener('click', () => showSection('stats'));
    document.getElementById('loginLink').addEventListener('click', () => showSection('login'));
    document.getElementById('registerLink').addEventListener('click', () => showSection('register'));
    document.getElementById('showLoginLink').addEventListener('click', () => showSection('login'));
    document.getElementById('showRegisterLink').addEventListener('click', () => showSection('register'));

    // Show Section Function
    function showSection(sectionName) {
      Object.keys(sections).forEach(key => {
        sections[key].classList.add('d-none');
      });
      sections[sectionName].classList.remove('d-none');
    }

    // Auth State Change Listener
    auth.onAuthStateChanged(user => {
      if (user) {
        // User is signed in
        navItems.login.classList.add('d-none');
        navItems.register.classList.add('d-none');
        navItems.logout.classList.remove('d-none');
        showSection('dashboard');
        loadDashboardData();
      } else {
        // User is signed out
        navItems.login.classList.remove('d-none');
        navItems.register.classList.remove('d-none');
        navItems.logout.classList.add('d-none');
        showSection('login');
      }
    });

    // Login Functionality
    document.getElementById('loginButton').addEventListener('click', () => {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      auth.signInWithEmailAndPassword(email, password)
        .catch(error => {
          alert(`Login Error: ${error.message}`);
        });
    });

    // Register Functionality
    document.getElementById('registerButton').addEventListener('click', () => {
      const name = document.getElementById('registerName').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      
      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          // Add user to database
          return db.collection('users').doc(userCredential.user.uid).set({
            name: name,
            email: email,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        })
        .catch(error => {
          alert(`Registration Error: ${error.message}`);
        });
    });

    // Logout Functionality
    document.getElementById('logoutLink').addEventListener('click', () => {
      auth.signOut();
    });

    // Load Dashboard Data
    function loadDashboardData() {
      // Load recent activity
      db.collection('activities')
        .orderBy('timestamp', 'desc')
        .limit(5)
        .get()
        .then(snapshot => {
          const activityList = document.getElementById('recentActivityList');
          activityList.innerHTML = '';
          
          if (snapshot.empty) {
            activityList.innerHTML = '<li class="list-group-item">No recent activity</li>';
            return;
          }
          
          snapshot.forEach(doc => {
            const activity = doc.data();
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = `${activity.description} - ${formatDate(activity.timestamp.toDate())}`;
            activityList.appendChild(li);
          });
        });
      
      // Load upcoming games
      db.collection('games')
        .where('status', '==', 'upcoming')
        .orderBy('scheduledDate', 'asc')
        .limit(3)
        .get()
        .then(snapshot => {
          const gamesList = document.getElementById('upcomingGamesList');
          gamesList.innerHTML = '';
          
          if (snapshot.empty) {
            gamesList.innerHTML = '<p>No upcoming games scheduled</p>';
            return;
          }
          
          snapshot.forEach(doc => {
            const game = doc.data();
            const gameDate = game.scheduledDate.toDate();
            
            const gameCard = document.createElement('div');
            gameCard.className = 'card mb-3';
            gameCard.innerHTML = `
              <div class="card-body">
                <h5 class="card-title">${game.name}</h5>
                <h6 class="card-subtitle mb-2 text-muted">${formatDate(gameDate)} at ${formatTime(gameDate)}</h6>
                <p class="card-text">Location: ${game.location}<br>Game Type: ${formatGameType(game.type)}<br>Buy-in: $${game.buyIn}</p>
                <button class="btn btn-sm btn-outline-primary view-game-btn" data-id="${doc.id}">View Details</button>
              </div>
            `;
            gamesList.appendChild(gameCard);
          });
          
          // Add event listeners to view game buttons
          document.querySelectorAll('.view-game-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              loadGameDetails(btn.dataset.id);
              showSection('games');
            });
          });
        });
    }

    // Quick Action Buttons
    document.getElementById('newGameButton').addEventListener('click', () => {
      showSection('games');
      const newGameModal = new bootstrap.Modal(document.getElementById('newGameModal'));
      newGameModal.show();
    });

    document.getElementById('addPlayerButton').addEventListener('click', () => {
      showSection('players');
      const addPlayerModal = new bootstrap.Modal(document.getElementById('addPlayerModal'));
      addPlayerModal.show();
    });

    document.getElementById('viewStatsButton').addEventListener('click', () => {
      showSection('stats');
      loadStatsData();
    });

    // Players Management
    document.getElementById('savePlayerButton').addEventListener('click', () => {
      const name = document.getElementById('playerName').value;
      const email = document.getElementById('playerEmail').value;
      const phone = document.getElementById('playerPhone').value;
      
      if (!name) {
        alert('Player name is required');
        return;
      }
      
      // Add player to Firestore
      db.collection('players').add({
        name: name,
        email: email || null,
        phone: phone || null,
        createdBy: auth.currentUser.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        stats: {
          gamesPlayed: 0,
          wins: 0,
          totalBuyIns: 0,
          totalCashouts: 0
        }
      })
      .then(() => {
        // Close modal and refresh players list
        const modal = bootstrap.Modal.getInstance(document.getElementById('addPlayerModal'));
        modal.hide();
        loadPlayers();
        
        // Add activity
        addActivity(`Added new player: ${name}`);
        
        // Clear form
        document.getElementById('playerName').value = '';
        document.getElementById('playerEmail').value = '';
        document.getElementById('playerPhone').value = '';
      })
      .catch(error => {
        console.error("Error adding player: ", error);
        alert(`Error adding player: ${error.message}`);
      });
    });

    // Load Players Data
    function loadPlayers() {
      db.collection('players')
        .where('createdBy', '==', auth.currentUser.uid)
        .orderBy('name')
        .get()
        .then(snapshot => {
          const playersList = document.getElementById('playersList');
          playersList.innerHTML = '';
          
          if (snapshot.empty) {
            playersList.innerHTML = '<div class="col-12"><p>No players added yet.</p></div>';
            return;
          }
          
          snapshot.forEach(doc => {
            const player = doc.data();
            const playerCard = document.createElement('div');
            playerCard.className = 'col-md-4 mb-4';
            playerCard.innerHTML = `
              <div class="card player-card h-100">
                <div class="card-body">
                  <h5 class="card-title">${player.name}</h5>
                  <p class="card-text">
                    ${player.email ? `Email: ${player.email}<br>` : ''}
                    ${player.phone ? `Phone: ${player.phone}<br>` : ''}
                    Games Played: ${player.stats.gamesPlayed}<br>
                    Wins: ${player.stats.wins}<br>
                    Net Profit/Loss: ${(player.stats.totalCashouts - player.stats.totalBuyIns).toFixed(2)}
                  </p>
                </div>
                <div class="card-footer bg-transparent">
                  <button class="btn btn-sm btn-outline-primary edit-player-btn" data-id="${doc.id}">Edit</button>
                  <button class="btn btn-sm btn-outline-danger delete-player-btn" data-id="${doc.id}">Delete</button>
                </div>
              </div>
            `;
            playersList.appendChild(playerCard);
          });
          
          // Add event listeners to player buttons
          addPlayerButtonListeners();
        })
        .catch(error => {
          console.error("Error loading players: ", error);
        });
    }

    function addPlayerButtonListeners() {
      // Edit player buttons
      document.querySelectorAll('.edit-player-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const playerId = btn.dataset.id;
          editPlayer(playerId);
        });
      });
      
      // Delete player buttons
      document.querySelectorAll('.delete-player-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const playerId = btn.dataset.id;
          const confirmed = confirm('Are you sure you want to delete this player? This action cannot be undone.');
          
          if (confirmed) {
            deletePlayer(playerId);
          }
        });
      });
    }

    function editPlayer(playerId) {
      // Load player data and show edit modal
      db.collection('players').doc(playerId).get()
        .then(doc => {
          if (doc.exists) {
            const player = doc.data();
            
            // Populate form fields
            document.getElementById('playerName').value = player.name;
            document.getElementById('playerEmail').value = player.email || '';
            document.getElementById('playerPhone').value = player.phone || '';
            
            // Modify save button to update instead of add
            const saveButton = document.getElementById('savePlayerButton');
            saveButton.textContent = 'Update Player';
            saveButton.dataset.mode = 'edit';
            saveButton.dataset.id = playerId;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('addPlayerModal'));
            modal.show();
          }
        })
        .catch(error => {
          console.error("Error getting player: ", error);
        });
    }

    function deletePlayer(playerId) {
      db.collection('players').doc(playerId).get()
        .then(doc => {
          const playerName = doc.data().name;
          
          // Delete player document
          return db.collection('players').doc(playerId).delete()
            .then(() => {
              loadPlayers();
              addActivity(`Deleted player: ${playerName}`);
            });
        })
        .catch(error => {
          console.error("Error deleting player: ", error);
          alert(`Error deleting player: ${error.message}`);
        });
    }

    // Games Management
    document.getElementById('saveGameButton').addEventListener('click', () => {
      const name = document.getElementById('gameName').value;
      const date = document.getElementById('gameDate').value;
      const time = document.getElementById('gameTime').value;
      const location = document.getElementById('gameLocation').value;
      const gameType = document.getElementById('gameType').value;
      const buyIn = parseFloat(document.getElementById('buyIn').value);
      const startingChips = parseInt(document.getElementById('startingChips').value);
      const blindStructure = document.getElementById('blindStructure').value;
      
      if (!name || !date || !time || !location || !buyIn || !startingChips) {
        alert('Please fill in all required fields');
        return;
      }
      
      // Get selected players
      const selectedPlayers = [];
      document.querySelectorAll('#playerSelectionList input[type="checkbox"]:checked').forEach(checkbox => {
        selectedPlayers.push({
          id: checkbox.value,
          name: checkbox.dataset.name,
          status: 'registered',
          buyIns: 0,
          chips: 0
        });
      });
      
      // Create datetime object
      const dateTime = new Date(`${date}T${time}`);
      
      // Create game object
      const gameData = {
        name: name,
        scheduledDate: firebase.firestore.Timestamp.fromDate(dateTime),
        location: location,
        type: gameType,
        buyIn: buyIn,
        startingChips: startingChips,
        blindStructure: blindStructure,
        players: selectedPlayers,
        status: dateTime > new Date() ? 'upcoming' : 'active',
        createdBy: auth.currentUser.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        blindLevels: generateBlindLevels(blindStructure, buyIn),
        currentLevel: 0,
        totalPot: 0,
        gameLog: []
      };
      
      // Add game to Firestore
      db.collection('games').add(gameData)
        .then(docRef => {
          // Close modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('newGameModal'));
          modal.hide();
          
          // Add activity
          addActivity(`Created new game: ${name}`);
          
          // Clear form
          document.getElementById('gameName').value = '';
          document.getElementById('gameDate').value = '';
          document.getElementById('gameTime').value = '';
          document.getElementById('gameLocation').value = '';
          document.getElementById('buyIn').value = '';
          document.getElementById('startingChips').value = '';
          
          // If game is active, show it
          if (gameData.status === 'active') {
            loadActiveGame(docRef.id);
          } else {
            loadGames('upcoming');
          }
          
          // Update stats
          updateStats();
        })
        .catch(error => {
          console.error("Error adding game: ", error);
          alert(`Error adding game: ${error.message}`);
        });
    });

    // Generate blind levels based on structure
    function generateBlindLevels(structure, buyIn) {
      const levels = [];
      let smallBlind = Math.max(1, Math.floor(buyIn * 0.01)); // Start at 1% of buy-in
      let duration = 0;
      
      switch (structure) {
        case 'slow':
          duration = 20; // 20 minutes per level
          break;
        case 'medium':
          duration = 15; // 15 minutes per level
          break;
        case 'fast':
          duration = 10; // 10 minutes per level
          break;
        case 'custom':
          duration = 15; // Default to medium for custom
          break;
      }
      
      // Generate 15 blind levels
      for (let i = 0; i < 15; i++) {
        levels.push({
          level: i + 1,
          smallBlind: smallBlind,
          bigBlind: smallBlind * 2,
          duration: duration // minutes
        });
        
        // Increase blinds for next level
        if (i < 5) {
          // First 5 levels: increase by 50-100%
          smallBlind = Math.ceil(smallBlind * (Math.random() * 0.5 + 1.5));
        } else if (i < 10) {
          // Next 5 levels: increase by 30-70%
          smallBlind = Math.ceil(smallBlind * (Math.random() * 0.4 + 1.3));
        } else {
          // Final levels: increase by 20-50%
          smallBlind = Math.ceil(smallBlind * (Math.random() * 0.3 + 1.2));
        }
        
        // Round to nice numbers
        if (smallBlind < 100) {
          smallBlind = Math.ceil(smallBlind / 5) * 5; // Round to nearest 5
        } else {
          smallBlind = Math.ceil(smallBlind / 25) * 25; // Round to nearest 25
        }
      }
      
      return levels;
    }
    
    // Load Games by Status
    function loadGames(status) {
      // Set active tab
      document.querySelectorAll('.nav-link').forEach(tab => tab.classList.remove('active'));
      let activeTab;
      
      switch (status) {
        case 'active':
          activeTab = document.getElementById('activeGamesTab');
          break;
        case 'upcoming':
          activeTab = document.getElementById('upcomingGamesTab');
          break;
        case 'completed':
          activeTab = document.getElementById('pastGamesTab');
          break;
      }
      
      if (activeTab) {
        activeTab.classList.add('active');
      }
      
      // Load games from Firestore
      db.collection('games')
        .where('createdBy', '==', auth.currentUser.uid)
        .where('status', '==', status)
        .orderBy(status === 'upcoming' ? 'scheduledDate' : 'createdAt', status === 'upcoming' ? 'asc' : 'desc')
        .get()
        .then(snapshot => {
          const gamesList = document.getElementById('gamesList');
          gamesList.innerHTML = '';
          
          if (snapshot.empty) {
            gamesList.innerHTML = `<p>No ${status} games found.</p>`;
            return;
          }
          
          snapshot.forEach(doc => {
            const game = doc.data();
            const gameDate = game.scheduledDate.toDate();
            
            const gameCard = document.createElement('div');
            gameCard.className = 'card mb-3';
            
            let statusBadge = '';
            switch (status) {
              case 'active':
                statusBadge = '<span class="badge bg-success float-end">Active</span>';
                break;
              case 'upcoming':
                statusBadge = '<span class="badge bg-primary float-end">Upcoming</span>';
                break;
              case 'completed':
                statusBadge = '<span class="badge bg-secondary float-end">Completed</span>';
                break;
            }
            
            let playersList = '';
            if (game.players && game.players.length > 0) {
              game.players.forEach(player => {
                playersList += `<li>${player.name}</li>`;
              });
            } else {
              playersList = '<li>No players registered yet</li>';
            }
            
            gameCard.innerHTML = `
              <div class="card-body">
                <h5 class="card-title">${game.name} ${statusBadge}</h5>
                <h6 class="card-subtitle mb-2 text-muted">${formatDate(gameDate)} at ${formatTime(gameDate)}</h6>
                <div class="row">
                  <div class="col-md-6">
                    <p>
                      Location: ${game.location}<br>
                      Game Type: ${formatGameType(game.type)}<br>
                      Buy-in: ${game.buyIn}<br>
                      Starting Chips: ${game.startingChips}
                    </p>
                  </div>
                  <div class="col-md-6">
                    <p>Players (${game.players.length}):</p>
                    <ul>${playersList}</ul>
                  </div>
                </div>
                <div class="text-end">
                  ${status === 'active' ? 
                    `<button class="btn btn-primary resume-game-btn" data-id="${doc.id}">Resume Game</button>` :
                    status === 'upcoming' ? 
                      `<button class="btn btn-primary start-game-btn" data-id="${doc.id}">Start Game</button>` :
                      `<button class="btn btn-outline-primary view-results-btn" data-id="${doc.id}">View Results</button>`
                  }
                </div>
              </div>
            `;
            
            gamesList.appendChild(gameCard);
          });
          
          // Add event listeners to game buttons
          if (status === 'active') {
            document.querySelectorAll('.resume-game-btn').forEach(btn => {
              btn.addEventListener('click', () => {
                loadActiveGame(btn.dataset.id);
              });
            });
          } else if (status === 'upcoming') {
            document.querySelectorAll('.start-game-btn').forEach(btn => {
              btn.addEventListener('click', () => {
                startGame(btn.dataset.id);
              });
            });
          } else {
            document.querySelectorAll('.view-results-btn').forEach(btn => {
              btn.addEventListener('click', () => {
                viewGameResults(btn.dataset.id);
              });
            });
          }
        })
        .catch(error => {
          console.error("Error loading games: ", error);
        });
    }

    // Tab navigation
    document.getElementById('activeGamesTab').addEventListener('click', (e) => {
      e.preventDefault();
      loadGames('active');
    });
    
    document.getElementById('upcomingGamesTab').addEventListener('click', (e) => {
      e.preventDefault();
      loadGames('upcoming');
    });
    
    document.getElementById('pastGamesTab').addEventListener('click', (e) => {
      e.preventDefault();
      loadGames('completed');
    });
    
    // Start a game
    function startGame(gameId) {
      db.collection('games').doc(gameId).update({
        status: 'active',
        startTime: firebase.firestore.FieldValue.serverTimestamp(),
        currentLevel: 0,
        levelStartTime: firebase.firestore.FieldValue.serverTimestamp(),
        gameLog: firebase.firestore.FieldValue.arrayUnion({
          action: 'gameStart',
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          description: 'Game started'
        })
      })
      .then(() => {
        loadActiveGame(gameId);
        addActivity(`Started game`);
      })
      .catch(error => {
        console.error("Error starting game: ", error);
        alert(`Error starting game: ${error.message}`);
      });
    }
    
    // Load active game
    function loadActiveGame(gameId) {
      currentGameId = gameId;
      
      db.collection('games').doc(gameId).get()
        .then(doc => {
          if (!doc.exists) {
            console.error("Game not found");
            return;
          }
          
          const game = doc.data();
          
          // Set game info
          document.getElementById('activeGameName').textContent = game.name;
          document.getElementById('gameBuyIn').textContent = `${game.buyIn}`;
          document.getElementById('playerCount').textContent = game.players.length;
          document.getElementById('totalPot').textContent = `${game.totalPot || 0}`;
          
          // Set blind level info
          const currentLevel = game.currentLevel || 0;
          const blindLevel = game.blindLevels[currentLevel];
          
          document.getElementById('currentLevel').textContent = blindLevel.level;
          document.getElementById('currentBlinds').textContent = `${blindLevel.smallBlind}/${blindLevel.bigBlind}`;
          
          // Load players
          const playersList = document.getElementById('activePlayersList');
          playersList.innerHTML = '';
          
          if (game.players && game.players.length > 0) {
            game.players.forEach(player => {
              const tr = document.createElement('tr');
              
              let statusBadge = '';
              switch (player.status) {
                case 'active':
                  statusBadge = '<span class="badge bg-success">Active</span>';
                  break;
                case 'out':
                  statusBadge = '<span class="badge bg-danger">Out</span>';
                  break;
                case 'registered':
                  statusBadge = '<span class="badge bg-warning">Not Seated</span>';
                  break;
              }
              
              tr.innerHTML = `
                <td>${player.name}</td>
                <td>${player.buyIns * game.buyIn || 0}</td>
                <td>${player.chips || 0}</td>
                <td>${statusBadge}</td>
                <td>
                  ${player.status !== 'out' ? 
                    `<div class="btn-group btn-group-sm">
                      <button class="btn btn-sm btn-outline-primary buyin-btn" data-id="${player.id}" data-name="${player.name}">Buy-in</button>
                      <button class="btn btn-sm btn-outline-warning rebuy-btn" data-id="${player.id}" data-name="${player.name}">Rebuy</button>
                      <button class="btn btn-sm btn-outline-danger out-btn" data-id="${player.id}" data-name="${player.name}">Out</button>
                    </div>` : 
                    `<button class="btn btn-sm btn-outline-secondary cashout-btn" data-id="${player.id}" data-name="${player.name}">Cash Out</button>`
                  }
                </td>
              `;
              
              playersList.appendChild(tr);
            });
            
            // Add event listeners to player action buttons
            addGamePlayerButtonListeners(gameId);
          } else {
            playersList.innerHTML = '<tr><td colspan="5" class="text-center">No players in this game</td></tr>';
          }
          
          // Load game log
          const logList = document.getElementById('gameLogList');
          logList.innerHTML = '';
          
          if (game.gameLog && game.gameLog.length > 0) {
            game.gameLog.slice().reverse().forEach(log => {
              const li = document.createElement('li');
              li.className = 'list-group-item';
              
              // Format timestamp if it exists
              let timeStr = '';
              if (log.timestamp) {
                timeStr = `[${formatTime(log.timestamp.toDate())}] `;
              }
              
              li.textContent = `${timeStr}${log.description}`;
              logList.appendChild(li);
            });
          } else {
            logList.innerHTML = '<li class="list-group-item">No game activity logged yet</li>';
          }
          
          // Set up timer
          startLevelTimer(game, gameId);
          
          // Show active game section
          showSection('activeGame');
        })
        .catch(error => {
          console.error("Error loading active game: ", error);
        });
    }
    
    // Timer variables
    let timerInterval;
    let currentGameId;
    
    // Start the level timer
    function startLevelTimer(game, gameId) {
      // Clear any existing timer
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      
      const currentLevel = game.currentLevel || 0;
      const blindLevel = game.blindLevels[currentLevel];
      const duration = blindLevel.duration * 60; // Convert to seconds
      
      // Calculate remaining time
      let remainingTime = duration;
      if (game.levelStartTime) {
        const levelStartTime = game.levelStartTime.toDate();
        const elapsedSeconds = Math.floor((new Date() - levelStartTime) / 1000);
        remainingTime = Math.max(0, duration - elapsedSeconds);
      }
      
      updateTimerDisplay(remainingTime);
      
      // Start timer interval
      timerInterval = setInterval(() => {
        remainingTime--;
        
        if (remainingTime <= 0) {
          clearInterval(timerInterval);
          // Auto advance to next level if timer reaches zero
          advanceToNextLevel(gameId);
        } else {
          updateTimerDisplay(remainingTime);
        }
      }, 1000);
    }
    
    // Update timer display
    function updateTimerDisplay(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      document.getElementById('levelTimer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
      
      // Change timer color based on remaining time
      const timerElement = document.getElementById('levelTimer');
      if (seconds < 60) { // Less than 1 minute
        timerElement.style.color = '#dc3545'; // Red
      } else if (seconds < 180) { // Less than 3 minutes
        timerElement.style.color = '#fd7e14'; // Orange
      } else {
        timerElement.style.color = ''; // Default
      }
    }
    
    // Advance to next blind level
    function advanceToNextLevel(gameId) {
      db.collection('games').doc(gameId).get()
        .then(doc => {
          const game = doc.data();
          const currentLevel = game.currentLevel || 0;
          
          // Check if we're at the last level
          if (currentLevel >= game.blindLevels.length - 1) {
            alert('This is the final blind level');
            return;
          }
          
          const nextLevel = currentLevel + 1;
          const nextBlindLevel = game.blindLevels[nextLevel];
          
          return db.collection('games').doc(gameId).update({
            currentLevel: nextLevel,
            levelStartTime: firebase.firestore.FieldValue.serverTimestamp(),
            gameLog: firebase.firestore.FieldValue.arrayUnion({
              action: 'levelChange',
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
              description: `Blinds increased to ${nextBlindLevel.smallBlind}/${nextBlindLevel.bigBlind}`
            })
          }).then(() => {
            // Update UI
            document.getElementById('currentLevel').textContent = nextBlindLevel.level;
            document.getElementById('currentBlinds').textContent = `${nextBlindLevel.smallBlind}/${nextBlindLevel.bigBlind}`;
            
            // Reload game to refresh everything
            loadActiveGame(gameId);
          });
        })
        .catch(error => {
          console.error("Error advancing level: ", error);
        });
    }
    
    // Next level button
    document.getElementById('nextLevelButton').addEventListener('click', () => {
      if (currentGameId) {
        advanceToNextLevel(currentGameId);
      }
    });
    
    // Add player button listeners
    function addGamePlayerButtonListeners(gameId) {
      // Buy-in buttons
      document.querySelectorAll('.buyin-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const playerId = btn.dataset.id;
          const playerName = btn.dataset.name;
          processBuyIn(gameId, playerId, playerName);
        });
      });
      
      // Rebuy buttons
      document.querySelectorAll('.rebuy-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const playerId = btn.dataset.id;
          const playerName = btn.dataset.name;
          
          // Set player name in rebuy modal
          document.getElementById('rebuyPlayerName').textContent = playerName;
          document.getElementById('rebuyAmount').value = '';
          document.getElementById('rebuyChips').value = '';
          
          // Set data attributes on confirm button
          document.getElementById('confirmRebuyButton').dataset.id = playerId;
          document.getElementById('confirmRebuyButton').dataset.gameId = gameId;
          
          // Show rebuy modal
          const rebuyModal = new bootstrap.Modal(document.getElementById('rebuyModal'));
          rebuyModal.show();
        });
      });
      
      // Out buttons
      document.querySelectorAll('.out-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const playerId = btn.dataset.id;
          const playerName = btn.dataset.name;
          
          const confirmed = confirm(`Mark ${playerName} as out of the game?`);
          if (confirmed) {
            markPlayerOut(gameId, playerId, playerName);
          }
        });
      });
      
      // Cash out buttons
      document.querySelectorAll('.cashout-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const playerId = btn.dataset.id;
          const playerName = btn.dataset.name;
          
          cashoutPlayer(gameId, playerId, playerName);
        });
      });
    }
    
    // Process player buy-in
    function processBuyIn(gameId, playerId, playerName) {
      db.collection('games').doc(gameId).get()
        .then(doc => {
          const game = doc.data();
          
          // Find player in the game
          const playerIndex = game.players.findIndex(p => p.id === playerId);
          
          if (playerIndex === -1) {
            console.error("Player not found in game");
            return;
          }
          
          // Calculate values
          const buyInAmount = game.buyIn;
          const startingChips = game.startingChips;
          
          // Update player data
          game.players[playerIndex].status = 'active';
          game.players[playerIndex].buyIns = (game.players[playerIndex].buyIns || 0) + 1;
          game.players[playerIndex].chips = (game.players[playerIndex].chips || 0) + startingChips;
          
          // Update game
          const totalPot = (game.totalPot || 0) + buyInAmount;
          
          return db.collection('games').doc(gameId).update({
            players: game.players,
            totalPot: totalPot,
            gameLog: firebase.firestore.FieldValue.arrayUnion({
              action: 'buyIn',
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
              playerId: playerId,
              playerName: playerName,
              amount: buyInAmount,
              chips: startingChips,
              description: `${playerName} bought in for ${buyInAmount} (${startingChips} chips)`
            })
          }).then(() => {
            // Reload active game
            loadActiveGame(gameId);
            addActivity(`${playerName} bought into game for ${buyInAmount}`);
          });
        })
        .catch(error => {
          console.error("Error processing buy-in: ", error);
          alert(`Error processing buy-in: ${error.message}`);
        });
    }
    
    // Process player rebuy
    document.getElementById('confirmRebuyButton').addEventListener('click', () => {
      const playerId = document.getElementById('confirmRebuyButton').dataset.id;
      const gameId = document.getElementById('confirmRebuyButton').dataset.gameId;
      const playerName = document.getElementById('rebuyPlayerName').textContent;
      
      const rebuyAmount = parseFloat(document.getElementById('rebuyAmount').value);
      const rebuyChips = parseInt(document.getElementById('rebuyChips').value);
      
      if (!rebuyAmount || !rebuyChips) {
        alert('Please enter both rebuy amount and chips received');
        return;
      }
      
      db.collection('games').doc(gameId).get()
        .then(doc => {
          const game = doc.data();
          
          // Find player in the game
          const playerIndex = game.players.findIndex(p => p.id === playerId);
          
          if (playerIndex === -1) {
            console.error("Player not found in game");
            return;
          }
          
          // Update player data
          game.players[playerIndex].buyIns = (game.players[playerIndex].buyIns || 0) + (rebuyAmount / game.buyIn);
          game.players[playerIndex].chips = (game.players[playerIndex].chips || 0) + rebuyChips;
          
          // Update game
          const totalPot = (game.totalPot || 0) + rebuyAmount;
          
          return db.collection('games').doc(gameId).update({
            players: game.players,
            totalPot: totalPot,
            gameLog: firebase.firestore.FieldValue.arrayUnion({
              action: 'rebuy',
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
              playerId: playerId,
              playerName: playerName,
              amount: rebuyAmount,
              chips: rebuyChips,
              description: `${playerName} rebought for ${rebuyAmount} (${rebuyChips} chips)`
            })
          }).then(() => {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('rebuyModal'));
            modal.hide();
            
            // Reload active game
            loadActiveGame(gameId);
            addActivity(`${playerName} rebought for ${rebuyAmount}`);
          });
        })
        .catch(error => {
          console.error("Error processing rebuy: ", error);
          alert(`Error processing rebuy: ${error.message}`);
        });
    });
    
    // Mark player as out
    function markPlayerOut(gameId, playerId, playerName) {
      db.collection('games').doc(gameId).get()
        .then(doc => {
          const game = doc.data();
          
          // Find player in the game
          const playerIndex = game.players.findIndex(p => p.id === playerId);
          
          if (playerIndex === -1) {
            console.error("Player not found in game");
            return;
          }
          
          // Update player status
          game.players[playerIndex].status = 'out';
          game.players[playerIndex].chips = 0;
          game.players[playerIndex].outTime = firebase.firestore.FieldValue.serverTimestamp();
          
          return db.collection('games').doc(gameId).update({
            players: game.players,
            gameLog: firebase.firestore.FieldValue.arrayUnion({
              action: 'out',
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
              playerId: playerId,
              playerName: playerName,
              description: `${playerName} is out of the game`
            })
          }).then(() => {
            // Reload active game
            loadActiveGame(gameId);
            addActivity(`${playerName} is out of the game`);
          });
        })
        .catch(error => {
          console.error("Error marking player out: ", error);
          alert(`Error: ${error.message}`);
        });
    }
    
    // Cash out player
    function cashoutPlayer(gameId, playerId, playerName) {
      const cashoutAmount = prompt(`Enter cash out amount for ${playerName}:`, "0");
      
      if (cashoutAmount === null) {
        return; // User cancelled
      }
      
      const amount = parseFloat(cashoutAmount);
      
      if (isNaN(amount)) {
        alert('Please enter a valid number');
        return;
      }
      
      db.collection('games').doc(gameId).get()
        .then(doc => {
          const game = doc.data();
          
          // Find player in the game
          const playerIndex = game.players.findIndex(p => p.id === playerId);
          
          if (playerIndex === -1) {
            console.error("Player not found in game");
            return;
          }
          
          // Calculate profit/loss
          const buyInTotal = game.players[playerIndex].buyIns * game.buyIn;
          const profit = amount - buyInTotal;
          
          // Update player data
          game.players[playerIndex].cashout = amount;
          game.players[playerIndex].profit = profit;
          
          // Update player stats in the database
          updatePlayerStats(playerId, game.players[playerIndex]);
          
          return db.collection('games').doc(gameId).update({
            players: game.players,
            gameLog: firebase.firestore.FieldValue.arrayUnion({
              action: 'cashout',
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
              playerId: playerId,
              playerName: playerName,
              amount: amount,
              profit: profit,
              description: `${playerName} cashed out ${amount} (${profit >= 0 ? '+' : ''}${profit})`
            })
          }).then(() => {
            // Reload active game
            loadActiveGame(gameId);
            addActivity(`${playerName} cashed out ${amount}`);
          });
        })
        .catch(error => {
          console.error("Error processing cashout: ", error);
          alert(`Error: ${error.message}`);
        });
    }
    
    // Update player statistics
    function updatePlayerStats(playerId, playerGameData) {
      db.collection('players').doc(playerId).get()
        .then(doc => {
          if (!doc.exists) {
            console.error("Player not found");
            return;
          }
          
          const player = doc.data();
          const stats = player.stats || {
            gamesPlayed: 0,
            wins: 0,
            totalBuyIns: 0,
            totalCashouts: 0
          };
          
          // Update stats
          stats.gamesPlayed += 1;
          stats.totalBuyIns += playerGameData.buyIns * playerGameData.buyIn;
          stats.totalCashouts += playerGameData.cashout || 0;
          
          if (playerGameData.profit > 0) {
            stats.wins += 1;
          }
          
          return db.collection('players').doc(playerId).update({
            stats: stats
          });
        })
        .catch(error => {
          console.error("Error updating player stats: ", error);
        });
    }
    
    // End game
    document.getElementById('endGameButton').addEventListener('click', () => {
      if (!currentGameId) {
        return;
      }
      
      const confirmed = confirm('Are you sure you want to end this game? All players should be cashed out first.');
      
      if (!confirmed) {
        return;
      }
      
      db.collection('games').doc(currentGameId).get()
        .then(doc => {
          const game = doc.data();
          
          // Check if all players have cashed out
          const playersNotCashedOut = game.players.filter(p => p.status === 'active' && !p.cashout);
          
          if (playersNotCashedOut.length > 0) {
            const proceed = confirm(`Warning: ${playersNotCashedOut.length} active players have not cashed out. Proceed anyway?`);
            
            if (!proceed) {
              return;
            }
          }
          
          return db.collection('games').doc(currentGameId).update({
            status: 'completed',
            endTime: firebase.firestore.FieldValue.serverTimestamp(),
            gameLog: firebase.firestore.FieldValue.arrayUnion({
              action: 'gameEnd',
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
              description: 'Game ended'
            })
          }).then(() => {
            // Clear timer
            if (timerInterval) {
              clearInterval(timerInterval);
            }
            
            // Return to games list
            showSection('games');
            loadGames('completed');
            addActivity('Game ended');
            
            // Update stats
            updateStats();
          });
        })
        .catch(error => {
          console.error("Error ending game: ", error);
          alert(`Error: ${error.message}`);
        });
    });
    
    // Pause game
    document.getElementById('pauseGameButton').addEventListener('click', () => {
      if (!currentGameId) {
        return;
      }
      
      // Toggle pause/resume
      const button = document.getElementById('pauseGameButton');
      const isPaused = button.textContent === 'Resume';
      
      if (isPaused) {
        // Resume game
        button.textContent = 'Pause';
        document.getElementById('gameStatus').textContent = 'In Progress';
        document.getElementById('gameStatus').className = 'badge bg-success me-2';
        
        db.collection('games').doc(currentGameId).update({
          paused: false,
          levelStartTime: firebase.firestore.FieldValue.serverTimestamp(),
          gameLog: firebase.firestore.FieldValue.arrayUnion({
            action: 'resume',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            description: 'Game resumed'
          })
        }).then(() => {
          // Reload to start timer
          loadActiveGame(currentGameId);
        });
      } else {
        // Pause game
        button.textContent = 'Resume';
        document.getElementById('gameStatus').textContent = 'Paused';
        document.getElementById('gameStatus').className = 'badge bg-warning me-2';
        
        // Clear timer
        if (timerInterval) {
          clearInterval(timerInterval);
        }
        
        db.collection('games').doc(currentGameId).update({
          paused: true,
          gameLog: firebase.firestore.FieldValue.arrayUnion({
            action: 'pause',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            description: 'Game paused'
          })
        });
      }
    });
    
    // Add player to game modal
    document.getElementById('addPlayerToGameButton').addEventListener('click', () => {
      if (!currentGameId) {
        return;
      }
      
      const playerId = document.getElementById('gamePlayerSelect').value;
      const playerName = document.getElementById('gamePlayerSelect').selectedOptions[0].text;
      const buyIn = parseFloat(document.getElementById('playerBuyIn').value);
      const startingChips = parseInt(document.getElementById('playerStartingChips').value);
      
      if (!playerId || !buyIn || !startingChips) {
        alert('Please fill in all fields');
        return;
      }
      
      db.collection('games').doc(currentGameId).get()
        .then(doc => {
          const game = doc.data();
          
          // Check if player already in game
          const playerExists = game.players.some(p => p.id === playerId);
          
          if (playerExists) {
            alert('This player is already in the game');
            return;
          }
          
          // Add player to game
          const newPlayer = {
            id: playerId,
            name: playerName,
            status: 'active',
            buyIns: buyIn / game.buyIn,
            chips: startingChips
          };
          
          game.players.push(newPlayer);
          
          // Update total pot
          const totalPot = (game.totalPot || 0) + buyIn;
          
          return db.collection('games').doc(currentGameId).update({
            players: game.players,
            totalPot: totalPot,
            gameLog: firebase.firestore.FieldValue.arrayUnion({
              action: 'playerAdded',
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
              playerId: playerId,
              playerName: playerName,
              amount: buyIn,
              chips: startingChips,
              description: `${playerName} joined the game with ${buyIn} buy-in (${startingChips} chips)`
            })
          }).then(() => {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addPlayerToGameModal'));
            modal.hide();
            
            // Reload active game
            loadActiveGame(currentGameId);
            addActivity(`${playerName} added to game`);
            
            // Clear form
            document.getElementById('playerBuyIn').value = '';
            document.getElementById('playerStartingChips').value = '';
          });
        })
        .catch(error => {
          console.error("Error adding player to game: ", error);
          alert(`Error: ${error.message}`);
        });
    });
    
    // Populate player select in add player to game modal
    function populatePlayerSelect() {
      db.collection('players')
        .where('createdBy', '==', auth.currentUser.uid)
        .orderBy('name')
        .get()
        .then(snapshot => {
          const playerSelect = document.getElementById('gamePlayerSelect');
          playerSelect.innerHTML = '';
          
          if (snapshot.empty) {
            playerSelect.innerHTML = '<option value="">No players available</option>';
            return;
          }
          
          snapshot.forEach(doc => {
            const player = doc.data();
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = player.name;
            playerSelect.appendChild(option);
          });
        })
        .catch(error => {
          console.error("Error loading players for select: ", error);
        });
    }
    
    // Populate player selection for new game
    function populatePlayerSelectionList() {
      db.collection('players')
        .where('createdBy', '==', auth.currentUser.uid)
        .orderBy('name')
        .get()
        .then(snapshot => {
          const playerList = document.getElementById('playerSelectionList');
          playerList.innerHTML = '';
          
          if (snapshot.empty) {
            playerList.innerHTML = '<p>No players available. Add players first.</p>';
            return;
          }
          
          snapshot.forEach(doc => {
            const player = doc.data();
            const div = document.createElement('div');
            div.className = 'form-check';
            div.innerHTML = `
              <input class="form-check-input" type="checkbox" value="${doc.id}" id="player_${doc.id}" data-name="${player.name}">
              <label class="form-check-label" for="player_${doc.id}">
                ${player.name}
              </label>
            `;
            playerList.appendChild(div);
          });
        })
        .catch(error => {
          console.error("Error loading players for selection: ", error);
        });
    }
    
    // Load stats data
    function loadStatsData() {
      // Get all completed games
      db.collection('games')
        .where('createdBy', '==', auth.currentUser.uid)
        .where('status', '==', 'completed')
        .get()
        .then(gamesSnapshot => {
          const games = [];
          gamesSnapshot.forEach(doc => {
            games.push({
              id: doc.id,
              ...doc.data()
            });
          });
          
          // Get all players
          return db.collection('players')
            .where('createdBy', '==', auth.currentUser.uid)
            .get()
            .then(playersSnapshot => {
              const players = [];
              playersSnapshot.forEach(doc => {
                players.push({
                  id: doc.id,
                  ...doc.data()
                });
              });
              
              updateStatsCounts(games, players);
              updateLeaderboard(games, players);
              updateRecentGames(games);
            });
        })
        .catch(error => {
          console.error("Error loading stats data: ", error);
        });
    }
    
    // Update stats counts
    function updateStatsCounts(games, players) {
      // Total games
      document.getElementById('totalGamesCount').textContent = games.length;
      
      // Total players
      document.getElementById('totalPlayersCount').textContent = players.length;
      
      // Calculate average buy-in
      let totalBuyIn = 0;
      let buyInCount = 0;
      
      games.forEach(game => {
        totalBuyIn += game.buyIn;
        buyInCount++;
      });
      
      const avgBuyIn = buyInCount > 0 ? totalBuyIn / buyInCount : 0;
      document.getElementById('avgBuyIn').textContent = `${avgBuyIn.toFixed(2)}`;
      
      // Find largest pot
      let largestPot = 0;
      
      games.forEach(game => {
        if (game.totalPot > largestPot) {
          largestPot = game.totalPot;
        }
      });
      
      document.getElementById('largestPot').textContent = `${largestPot}`;
    }
    
    // Update leaderboard
    function updateLeaderboard(games, players) {
      // Create player stats map
      const playerStats = {};
      
      players.forEach(player => {
        playerStats[player.id] = {
          id: player.id,
          name: player.name,
          wins: 0,
          totalProfit: 0,
          gamesPlayed: 0
        };
      });
      
      // Calculate stats from games
      games.forEach(game => {
        if (game.players) {
          game.players.forEach(gamePlayer => {
            if (playerStats[gamePlayer.id]) {
              const profit = gamePlayer.profit || 0;
              
              playerStats[gamePlayer.id].gamesPlayed++;
              playerStats[gamePlayer.id].totalProfit += profit;
              
              if (profit > 0) {
                playerStats[gamePlayer.id].wins++;
              }
            }
          });
        }
      });
      
      // Convert to array and sort by profit
      const leaderboardData = Object.values(playerStats)
        .filter(player => player.gamesPlayed > 0)
        .sort((a, b) => b.totalProfit - a.totalProfit);
      
      // Update leaderboard UI
      const leaderboardList = document.getElementById('leaderboardList');
      leaderboardList.innerHTML = '';
      
      if (leaderboardData.length === 0) {
        leaderboardList.innerHTML = '<tr><td colspan="4" class="text-center">No player data available</td></tr>';
        return;
      }
      
      leaderboardData.forEach((player, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${player.name}</td>
          <td>${player.wins}</td>
          <td class="${player.totalProfit >= 0 ? 'text-success' : 'text-danger'}">
            ${player.totalProfit >= 0 ? '+' : ''}${player.totalProfit.toFixed(2)}
          </td>
        `;
        leaderboardList.appendChild(tr);
      });
    }
    
    // Update recent games list
    function updateRecentGames(allGames) {
      // Sort games by date (most recent first)
      const recentGames = allGames.sort((a, b) => {
        const dateA = a.endTime ? a.endTime.toDate() : new Date(0);
        const dateB = b.endTime ? b.endTime.toDate() : new Date(0);
        return dateB - dateA;
      }).slice(0, 5); // Get most recent 5
      
      const recentGamesList = document.getElementById('recentGamesList');
      recentGamesList.innerHTML = '';
      
      if (recentGames.length === 0) {
        recentGamesList.innerHTML = '<p>No completed games yet</p>';
        return;
      }
      
      recentGames.forEach(game => {
        const gameDate = game.endTime ? game.endTime.toDate() : null;
        
        // Sort players by profit
        const players = game.players.sort((a, b) => (b.profit || 0) - (a.profit || 0));
        
        // Create game card
        const gameCard = document.createElement('div');
        gameCard.className = 'card mb-3';
        
        let winnersHtml = '';
        if (players.length > 0 && players[0].profit > 0) {
          const winners = players.filter(p => p.profit > 0);
          
          if (winners.length > 0) {
            winnersHtml = '<p class="mb-0"><strong>Winners:</strong></p><ul class="mb-0">';
            winners.forEach(winner => {
              winnersHtml += `<li>${winner.name}: +${winner.profit.toFixed(2)}</li>`;
            });
            winnersHtml += '</ul>';
          }
        }
        
        gameCard.innerHTML = `
          <div class="card-body">
            <h5 class="card-title">${game.name}</h5>
            <h6 class="card-subtitle mb-2 text-muted">
              ${gameDate ? formatDate(gameDate) : 'Date unknown'} - ${game.location}
            </h6>
            <p class="card-text">
              Players: ${game.players.length}<br>
              Total Pot: ${game.totalPot || 0}<br>
              ${winnersHtml}
            </p>
            <button class="btn btn-sm btn-outline-primary view-game-results-btn" data-id="${game.id}">
              View Details
            </button>
          </div>
        `;
        
        recentGamesList.appendChild(gameCard);
      });
      
      // Add event listeners
      document.querySelectorAll('.view-game-results-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          viewGameResults(btn.dataset.id);
        });
      });
    }
    
    // View game results
    function viewGameResults(gameId) {
      db.collection('games').doc(gameId).get()
        .then(doc => {
          if (!doc.exists) {
            console.error("Game not found");
            return;
          }
          
          const game = doc.data();
          
          // Sort players by profit
          const players = [...game.players].sort((a, b) => (b.profit || 0) - (a.profit || 0));
          
          // Create modal content
          let playersHtml = '';
          players.forEach(player => {
            const profit = player.profit || 0;
            playersHtml += `
              <tr>
                <td>${player.name}</td>
                <td>${(player.buyIns * game.buyIn).toFixed(2)}</td>
                <td>${player.cashout || 0}</td>
                <td class="${profit >= 0 ? 'text-success' : 'text-danger'}">
                  ${profit >= 0 ? '+' : ''}${profit.toFixed(2)}
                </td>
              </tr>
            `;
          });
          
          // Create modal
          const modal = document.createElement('div');
          modal.className = 'modal fade';
          modal.id = 'gameResultsModal';
          modal.innerHTML = `
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">${game.name} - Results</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <p>
                        <strong>Date:</strong> ${formatDate(game.endTime.toDate())}<br>
                        <strong>Location:</strong> ${game.location}<br>
                        <strong>Game Type:</strong> ${formatGameType(game.type)}<br>
                        <strong>Buy-in:</strong> ${game.buyIn}
                      </p>
                    </div>
                    <div class="col-md-6">
                      <p>
                        <strong>Total Pot:</strong> ${game.totalPot || 0}<br>
                        <strong>Players:</strong> ${game.players.length}<br>
                        <strong>Duration:</strong> ${calculateDuration(game.startTime, game.endTime)}
                      </p>
                    </div>
                  </div>
                  
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Player</th>
                          <th>Buy-in Total</th>
                          <th>Cash Out</th>
                          <th>Profit/Loss</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${playersHtml}
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          `;
          
          // Add modal to document
          document.body.appendChild(modal);
          
          // Show modal
          const bsModal = new bootstrap.Modal(modal);
          bsModal.show();
          
          // Remove modal from DOM when hidden
          modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
          });
        })
        .catch(error => {
          console.error("Error loading game results: ", error);
        });
    }
    
    // Add activity
    function addActivity(description) {
      db.collection('activities').add({
        description: description,
        userId: auth.currentUser.uid,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
    // Update stats
    function updateStats() {
      // This function is called after key events to update all stats
      if (sections.stats.classList.contains('d-none')) {
        return; // Don't update if stats not visible
      }
      
      loadStatsData();
    }
    
    // Helper functions
    function formatDate(date) {
      return date ? date.toLocaleDateString() : '';
    }
    
    function formatTime(date) {
      return date ? date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
    }
    
    function formatGameType(type) {
      switch (type) {
        case 'texas_holdem':
          return 'Texas Hold\'em';
        case 'omaha':
          return 'Omaha';
        case 'seven_card_stud':
          return 'Seven Card Stud';
        default:
          return type.charAt(0).toUpperCase() + type.slice(1).replace('_', ' ');
      }
    }
    
    function calculateDuration(startTime, endTime) {
      if (!startTime || !endTime) {
        return 'Unknown';
      }
      
      const start = startTime.toDate();
      const end = endTime.toDate();
      const diff = end - start;
      
      // Convert to hours and minutes
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      
      return `${hours}h ${minutes}m`;
    }
    
    // Event listeners for different sections
    document.getElementById('showPlayersLink').addEventListener('click', () => {
      showSection('players');
      loadPlayers();
    });
    
    document.getElementById('showGamesLink').addEventListener('click', () => {
      showSection('games');
      loadGames('upcoming');
    });
    
    // Init app functions
    function initApp() {
      // Setup event listeners
      document.getElementById('addPlayerToGameModal').addEventListener('show.bs.modal', () => {
        populatePlayerSelect();
        
        // Set default values based on current game
        db.collection('games').doc(currentGameId).get()
          .then(doc => {
            if (doc.exists) {
              const game = doc.data();
              document.getElementById('playerBuyIn').value = game.buyIn;
              document.getElementById('playerStartingChips').value = game.startingChips;
            }
          });
      });
      
      document.getElementById('newGameModal').addEventListener('show.bs.modal', () => {
        populatePlayerSelectionList();
        
        // Set default date to today
        const today = new Date();
        const dateString = today.toISOString().split('T')[0];
        document.getElementById('gameDate').value = dateString;
        
        // Set default time to evening (8pm)
        document.getElementById('gameTime').value = '20:00';
      });
    }
    
    // Initialize app when Firebase and page are ready
    initApp();
    
    // Check if user is authenticated and redirect accordingly
    auth.onAuthStateChanged(user => {
      if (user) {
        // Load initial dashboard data
        loadDashboardData();
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poker Game Manager</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block !important;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tab-btn {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            border-bottom: 2px solid #3b82f6;
            color: #374151;
        }
        .tab-btn:not(.active) {
            color: #6b7280;
        }
        /* Auth UI styles */
        .login-btn {
            transition: transform 0.1s ease;
        }
        .login-btn:active {
            transform: scale(0.98);
        }
        .user-avatar {
            background-color: #3b82f6;
            color: white;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        /* Mobile optimizations */
        @media (max-width: 640px) {
            .table-responsive {
                display: block;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .tab-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
            .btn-sm-block {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            .action-btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            .grid-cols-mobile-1 {
                grid-template-columns: 1fr !important;
            }
            .modal > div {
                margin: 0 1rem;
                max-width: calc(100% - 2rem);
            }
        }
        /* Game specific styling */
        .game-details {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Login Container -->
    <div id="login-container" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-md p-6 w-full max-w-md mx-4">
            <h1 class="text-2xl font-bold text-center text-blue-800 mb-6">Poker Game Manager</h1>
            
            <div id="login-form">
                <h2 class="text-xl font-semibold mb-4">Sign In</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Email</label>
                    <input type="email" id="login-email" class="w-full p-2 border rounded" placeholder="Enter your email">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                    <input type="password" id="login-password" class="w-full p-2 border rounded" placeholder="Enter your password">
                </div>
                <button id="login-button" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 mb-4">Sign In</button>
                <p class="text-center text-sm text-gray-600">Don't have an account? <a href="#" id="show-register" class="text-blue-600">Register</a></p>
                <div class="mt-4">
                    <p id="login-error" class="text-red-600 text-sm text-center hidden"></p>
                </div>
            </div>
            
            <div id="register-form" class="hidden">
                <h2 class="text-xl font-semibold mb-4">Register</h2>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Name</label>
                    <input type="text" id="register-name" class="w-full p-2 border rounded" placeholder="Enter your name">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Email</label>
                    <input type="email" id="register-email" class="w-full p-2 border rounded" placeholder="Enter your email">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                    <input type="password" id="register-password" class="w-full p-2 border rounded" placeholder="Create a password">
                </div>
                <div class="mb-6">
                    <div class="flex items-center">
                        <input type="checkbox" id="register-admin" class="mr-2">
                        <label for="register-admin" class="text-sm text-gray-700">Register as Admin</label>
                    </div>
                    <div id="admin-code-container" class="mt-2 hidden">
                        <input type="text" id="admin-code" class="w-full p-2 border rounded" placeholder="Enter admin code">
                        <p class="text-xs text-gray-500 mt-1">Admin code is required for administrator privileges</p>
                    </div>
                </div>
                <button id="register-button" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 mb-4">Register</button>
                <p class="text-center text-sm text-gray-600">Already have an account? <a href="#" id="show-login" class="text-blue-600">Sign In</a></p>
                <div class="mt-4">
                    <p id="register-error" class="text-red-600 text-sm text-center hidden"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container (hidden until login) -->
    <div id="app-container" class="hidden">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-center text-blue-800">Poker Game Manager</h1>
        </header>

        <!-- Tab Navigation -->
            <div class="mb-6 overflow-x-auto">
                <nav class="flex border-b border-gray-300 min-w-max">
                    <button type="button" class="tab-btn active px-4 py-2 font-medium" data-tab="schedule">Schedule</button>
                    <button type="button" class="tab-btn px-4 py-2 font-medium" data-tab="game">Current Game</button>
                    <button type="button" class="tab-btn px-4 py-2 font-medium" data-tab="players">Players</button>
                    <button type="button" class="tab-btn px-4 py-2 font-medium" data-tab="history">History</button>
            </nav>
        </div>

        <!-- Schedule Tab -->
        <div id="schedule" class="tab-content active">
                <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Weekly Schedule</h2>
                <p class="mb-4 text-gray-600">Select a game to book your seat</p>
                
                    <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 md:grid-cols-3">
                    <div class="border rounded-lg p-4 hover:shadow-md transition">
                        <h3 class="font-medium">Monday Night</h3>
                        <p class="text-sm text-gray-600 mb-2">8:00 PM - 12:00 AM</p>
                        <p class="text-sm mb-3">Players: <span id="monday-seats">0</span>/10+</p>
                        <p class="text-xs text-gray-500 mb-2">(Players beyond 10 are reserves)</p>
                        <button class="book-game w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700" data-day="monday">Book Seat</button>
                        
                        <!-- Admin section to add multiple players -->
                        <div class="mt-3 admin-only">
                            <button class="toggle-player-selector mb-2 w-full bg-blue-600 text-white py-1 px-3 rounded text-sm hover:bg-blue-700" data-day="monday">Add Players</button>
                            <div id="monday-player-selector" class="player-selector hidden border rounded p-2 mb-2 bg-gray-50 max-h-48 overflow-y-auto">
                                <div class="mb-2 flex justify-between items-center">
                                    <span class="text-sm font-medium">Select Players</span>
                                    <button class="select-all-players text-xs text-blue-600 hover:text-blue-800" data-day="monday">Select All</button>
                                </div>
                                <div id="monday-player-checkboxes" class="player-checkbox-list space-y-1">
                                    <!-- Checkboxes will be added here dynamically -->
                                </div>
                                <div class="mt-2 flex justify-end">
                                    <button class="add-selected-players bg-green-600 text-white py-1 px-3 rounded text-xs hover:bg-green-700" data-day="monday">Add Selected</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 text-sm">
                            <p class="font-medium">Players:</p>
                            <ul id="monday-players" class="list-disc pl-5"></ul>
                        </div>
                    </div>
                    
                    <div class="border rounded-lg p-4 hover:shadow-md transition">
                        <h3 class="font-medium">Wednesday Night</h3>
                        <p class="text-sm text-gray-600 mb-2">8:00 PM - 12:00 AM</p>
                        <p class="text-sm mb-3">Players: <span id="wednesday-seats">0</span>/10+</p>
                        <p class="text-xs text-gray-500 mb-2">(Players beyond 10 are reserves)</p>
                        <button class="book-game w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700" data-day="wednesday">Book Seat</button>
                        
                        <!-- Admin section to add multiple players -->
                        <div class="mt-3 admin-only">
                            <button class="toggle-player-selector mb-2 w-full bg-blue-600 text-white py-1 px-3 rounded text-sm hover:bg-blue-700" data-day="wednesday">Add Players</button>
                            <div id="wednesday-player-selector" class="player-selector hidden border rounded p-2 mb-2 bg-gray-50 max-h-48 overflow-y-auto">
                                <div class="mb-2 flex justify-between items-center">
                                    <span class="text-sm font-medium">Select Players</span>
                                    <button class="select-all-players text-xs text-blue-600 hover:text-blue-800" data-day="wednesday">Select All</button>
                                </div>
                                <div id="wednesday-player-checkboxes" class="player-checkbox-list space-y-1">
                                    <!-- Checkboxes will be added here dynamically -->
                                </div>
                                <div class="mt-2 flex justify-end">
                                    <button class="add-selected-players bg-green-600 text-white py-1 px-3 rounded text-xs hover:bg-green-700" data-day="wednesday">Add Selected</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 text-sm">
                            <p class="font-medium">Players:</p>
                            <ul id="wednesday-players" class="list-disc pl-5"></ul>
                        </div>
                    </div>
                    
                    <div class="border rounded-lg p-4 hover:shadow-md transition">
                        <h3 class="font-medium">Saturday Afternoon</h3>
                        <p class="text-sm text-gray-600 mb-2">2:00 PM - 6:00 PM</p>
                        <p class="text-sm mb-3">Players: <span id="saturday-seats">0</span>/10+</p>
                        <p class="text-xs text-gray-500 mb-2">(Players beyond 10 are reserves)</p>
                        <button class="book-game w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700" data-day="saturday">Book Seat</button>
                        
                        <!-- Admin section to add multiple players -->
                        <div class="mt-3 admin-only">
                            <button class="toggle-player-selector mb-2 w-full bg-blue-600 text-white py-1 px-3 rounded text-sm hover:bg-blue-700" data-day="saturday">Add Players</button>
                            <div id="saturday-player-selector" class="player-selector hidden border rounded p-2 mb-2 bg-gray-50 max-h-48 overflow-y-auto">
                                <div class="mb-2 flex justify-between items-center">
                                    <span class="text-sm font-medium">Select Players</span>
                                    <button class="select-all-players text-xs text-blue-600 hover:text-blue-800" data-day="saturday">Select All</button>
                                </div>
                                <div id="saturday-player-checkboxes" class="player-checkbox-list space-y-1">
                                    <!-- Checkboxes will be added here dynamically -->
                                </div>
                                <div class="mt-2 flex justify-end">
                                    <button class="add-selected-players bg-green-600 text-white py-1 px-3 rounded text-xs hover:bg-green-700" data-day="saturday">Add Selected</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 text-sm">
                            <p class="font-medium">Players:</p>
                            <ul id="saturday-players" class="list-disc pl-5"></ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Remove the universal Game Details section -->
            <!-- <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Game Details</h2>
                        <button id="edit-game-details" class="bg-blue-500 text-white py-1 px-3 rounded text-sm hover:bg-blue-600 admin-only">
                            Edit Details
                        </button>
                    </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <p class="text-sm text-gray-600">Buy-in Amount</p>
                            <p class="font-medium">$<span id="display-buyin-amount">50</span></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Starting Chips</p>
                            <p class="font-medium"><span id="display-starting-chips">5000</span></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Rebuys</p>
                            <p class="font-medium"><span id="display-rebuys">Allowed (max 2)</span></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Location</p>
                            <p class="font-medium"><span id="display-location">Main Street Poker Room</span></p>
                    </div>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Notes</p>
                        <p class="text-sm"><span id="display-notes">Please arrive 15 minutes early. Bring your own drinks, snacks will be provided.</span></p>
                </div>
            </div> -->
        </div>

        <!-- Current Game Tab -->
        <div id="game" class="tab-content">
                <div class="grid gap-6 grid-cols-1 md:grid-cols-2">
                    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 admin-only">
                    <h2 class="text-xl font-semibold mb-4">Start New Game</h2>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Select Game</label>
                        <select id="game-day" class="w-full p-2 border rounded">
                            <option value="monday">Monday Night</option>
                            <option value="wednesday">Wednesday Night</option>
                            <option value="saturday">Saturday Afternoon</option>
                        </select>
                    </div>
                    <button id="start-game" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700" onclick="startGame()">Start Game</button>
                </div>
                
                    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <h2 class="text-xl font-semibold mb-4">Current Game</h2>
                    <div id="current-game-info" class="hidden">
                        <div class="mb-4">
                            <p class="text-sm text-gray-600">Game:</p>
                            <p id="current-game-day" class="font-medium"></p>
                        </div>
                        <div class="mb-4">
                            <p class="text-sm text-gray-600">Date:</p>
                            <p id="current-game-date" class="font-medium"></p>
                        </div>
                        <div class="mb-4">
                            <p class="text-sm text-gray-600">Status:</p>
                            <p id="current-game-status" class="font-medium text-green-600">In Progress</p>
                        </div>
                        <div class="mb-4">
                            <p class="text-sm text-gray-600">Players:</p>
                            <p id="current-game-players" class="font-medium"></p>
                        </div>
                            <button id="end-game" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 admin-only">End Game</button>
                    </div>

                        <div class="mb-4 mt-4 admin-only">
                            <button id="add-players-to-current-game" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 mb-2">Add Players</button>
                            
                            <!-- Player selector (hidden by default) -->
                            <div id="current-game-player-selector" class="hidden border rounded p-3 bg-gray-50 mt-2">
                                <div class="mb-2 flex justify-between items-center">
                                    <span class="text-sm font-medium">Select Players to Add</span>
                                    <button class="select-all-current-game text-xs text-blue-600 hover:text-blue-800">Select All</button>
                                </div>
                                <div id="current-game-player-checkboxes" class="space-y-1 max-h-48 overflow-y-auto mb-2">
                                    <!-- Checkboxes will be added here dynamically -->
                                </div>
                                <div class="flex justify-end">
                                    <button id="add-selected-to-current-game" class="bg-green-600 text-white py-1 px-3 rounded text-xs hover:bg-green-700">Add Selected</button>
                                </div>
                            </div>
                        </div>

                    <div id="no-current-game" class="">
                        <p class="text-gray-600">No active game. Start a new game to begin tracking.</p>
                    </div>
                </div>
            </div>
            
                <div id="player-actions" class="mt-6 bg-white rounded-lg shadow-md p-4 sm:p-6 hidden">
                <h2 class="text-xl font-semibold mb-4">Player Actions</h2>
                
                    <div class="overflow-x-auto table-responsive">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="py-2 px-2 sm:px-3 text-left">Player</th>
                                    <th class="py-2 px-2 sm:px-3 text-right">Buy-ins</th>
                                    <th class="py-2 px-2 sm:px-3 text-right">End Chips</th>
                                    <th class="py-2 px-2 sm:px-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="player-actions-table">
                                <!-- Table content will be added dynamically -->
                            </tbody>
                            <tfoot>
                                <tr class="text-sm">
                                    <td class="py-2 px-2 sm:px-3">Dealer Tips</td>
                                    <td colspan="2" class="py-2 px-2 sm:px-3 text-right">
                                        <div class="flex justify-end items-center space-x-2">
                                            <span>$</span>
                                            <input type="number" id="dealer-tips" class="w-16 sm:w-24 p-1 border rounded text-right" placeholder="0">
                                            <button id="save-tips" class="bg-green-500 text-white py-1 px-2 sm:px-3 rounded text-xs hover:bg-green-600">Save</button>
                    </div>
                                        <div id="saved-tips-display" class="text-sm text-gray-600 mt-1 hidden">
                                            Saved: $<span id="saved-tips-amount">0</span>
                        </div>
                                    </td>
                                    <td class="py-2 px-2 sm:px-3"></td>
                                </tr>
                                <tr class="border-t-2 border-gray-300 font-semibold">
                                    <td class="py-2 px-2 sm:px-3">Totals</td>
                                    <td class="py-2 px-2 sm:px-3 text-right" id="total-buyins">$0</td>
                                    <td class="py-2 px-2 sm:px-3 text-right" id="total-chips">$0</td>
                                    <td class="py-2 px-2 sm:px-3"></td>
                                </tr>
                                <tr class="text-sm font-medium">
                                    <td class="py-2 px-2 sm:px-3">Final Balance</td>
                                    <td colspan="2" class="py-2 px-2 sm:px-3 text-right" id="total-difference">$0</td>
                                    <td class="py-2 px-2 sm:px-3"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Buy-in Amount</label>
                            <input type="number" id="buyin-amount" value="50" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">End Chips Amount</label>
                            <input type="number" id="chips-amount" class="w-full p-2 border rounded">
                    </div>
                </div>
            </div>
        </div>

        <!-- Players Tab -->
        <div id="players" class="tab-content">
                <div class="grid gap-6 grid-cols-1 md:grid-cols-2">
                    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 admin-only">
                    <h2 class="text-xl font-semibold mb-4">Add New Player</h2>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Player Name</label>
                        <input type="text" id="player-name" class="w-full p-2 border rounded" placeholder="Enter player name">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Email (optional)</label>
                        <input type="email" id="player-email" class="w-full p-2 border rounded" placeholder="Enter email address">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2">Phone (optional)</label>
                        <input type="tel" id="player-phone" class="w-full p-2 border rounded" placeholder="Enter phone number">
                    </div>
                    <button id="add-player" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Add Player</button>
                </div>
                
                    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <h2 class="text-xl font-semibold mb-4">Player List</h2>
                        <div class="overflow-x-auto table-responsive max-h-96">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                        <th class="py-2 px-2 sm:px-3 text-left">Name</th>
                                        <th class="py-2 px-2 sm:px-3 text-left">Email</th>
                                        <th class="py-2 px-2 sm:px-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="players-list">
                                <!-- Table content will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

                <!-- Leaderboard Section -->
                <div class="mt-6 bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <h2 class="text-xl font-semibold mb-4">Player Leaderboard</h2>
                    <div class="overflow-x-auto table-responsive">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="py-2 px-2 sm:px-3 text-left">Player</th>
                                    <th class="py-2 px-2 sm:px-3 text-right">Games</th>
                                    <th class="py-2 px-2 sm:px-3 text-right">Buy-ins</th>
                                    <th class="py-2 px-2 sm:px-3 text-right">Chips</th>
                                    <th class="py-2 px-2 sm:px-3 text-right">Profit/Loss</th>
                                    <th class="py-2 px-2 sm:px-3 text-right">Win Rate</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard">
                                <!-- Leaderboard content will be added here -->
                            </tbody>
                        </table>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
                <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Game History</h2>
                    <div class="overflow-x-auto table-responsive">
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-100">
                                    <th class="py-2 px-2 sm:px-3 text-left">Date</th>
                                    <th class="py-2 px-2 sm:px-3 text-left">Game</th>
                                    <th class="py-2 px-2 sm:px-3 text-center">Players</th>
                                    <th class="py-2 px-2 sm:px-3 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="game-history">
                            <!-- Table content will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
                <div id="game-details" class="bg-white rounded-lg shadow-md p-4 sm:p-6 hidden">
                <h2 class="text-xl font-semibold mb-4">Game Results: <span id="results-game-name"></span></h2>
                <div class="mb-4">
                    <p class="text-sm text-gray-600">Date: <span id="results-game-date"></span></p>
                </div>
                
                    <div class="overflow-x-auto table-responsive">
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-100">
                                    <th class="py-2 px-2 sm:px-3 text-left">Player</th>
                                    <th class="py-2 px-2 sm:px-3 text-right">Buy-ins</th>
                                    <th class="py-2 px-2 sm:px-3 text-right">End Chips</th>
                                    <th class="py-2 px-2 sm:px-3 text-right">Profit/Loss</th>
                            </tr>
                        </thead>
                        <tbody id="results-table">
                            <!-- Table content will be added here -->
                        </tbody>
                    </table>
                </div>
                
                    <div class="mt-6 flex flex-col sm:flex-row justify-between">
                        <button id="close-results" class="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600 mb-2 sm:mb-0">Back to History</button>
                    <button id="share-results" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">Share Results</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="booking-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
            <div class="bg-white rounded-lg p-4 sm:p-6 max-w-md w-full mx-4">
            <h2 class="text-xl font-semibold mb-4">Book a Seat</h2>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-2">Select Player</label>
                <select id="booking-player" class="w-full p-2 border rounded">
                    <!-- Options will be added dynamically -->
                </select>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="cancel-booking" class="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600">Cancel</button>
                <button id="confirm-booking" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">Book</button>
            </div>
        </div>
    </div>

    <div id="share-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
            <div class="bg-white rounded-lg p-4 sm:p-6 max-w-md w-full mx-4">
            <h2 class="text-xl font-semibold mb-4">Share Results</h2>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">Copy the link below to share with players:</p>
                <div class="flex">
                    <input id="share-link" class="w-full p-2 border rounded-l" readonly>
                    <button id="copy-link" class="bg-blue-600 text-white py-2 px-4 rounded-r hover:bg-blue-700">Copy</button>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-2">Or send directly:</label>
                <select id="share-players" class="w-full p-2 border rounded mb-2" multiple>
                    <!-- Options will be added dynamically -->
                </select>
                <button id="email-results" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Email Results</button>
            </div>
            <div class="flex justify-end">
                <button id="close-share" class="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600">Close</button>
            </div>
        </div>
    </div>

    <!-- Add help tooltip popup -->
    <div id="help-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
            <div class="bg-white rounded-lg p-4 sm:p-6 max-w-lg w-full mx-4">
            <h2 class="text-xl font-semibold mb-4">Poker Game Manager Help</h2>
            <div class="mb-4 max-h-96 overflow-y-auto">
                <h3 class="font-medium text-lg mb-2">Getting Started</h3>
                <p class="mb-3">Welcome to Poker Game Manager! This app helps you organize your poker games, track results, and share them with players.</p>
                
                <h3 class="font-medium text-lg mb-2">Schedule Tab</h3>
                <p class="mb-3">Here you can see upcoming games and allow players to book seats. Players need to be registered first in the Players tab.</p>
                
                <h3 class="font-medium text-lg mb-2">Current Game Tab</h3>
                <p class="mb-3">Start a new game, record buy-ins and track end-game chip counts. The app will automatically calculate profits and losses.</p>
                
                <h3 class="font-medium text-lg mb-2">Players Tab</h3>
                <p class="mb-3">Add and manage players. You can include contact information to easily share game results later.</p>
                
                <h3 class="font-medium text-lg mb-2">History Tab</h3>
                <p class="mb-3">View past games and their results. You can share these results with players via a link or email.</p>
                
                <h3 class="font-medium text-lg mb-2">Tips for Hosts</h3>
                <ul class="list-disc pl-5 mb-3">
                    <li>Start the game from the Current Game tab</li>
                    <li>Record buy-ins as players join</li>
                    <li>At the end of the game, record each player's chip count</li>
                    <li>End the game to save it to history</li>
                    <li>Share results with players from the History tab</li>
                </ul>
            </div>
            <div class="flex justify-end">
                <button id="close-help" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">Got it</button>
            </div>
        </div>
    </div>
        
        <!-- User Profile/Logout Button (fixed position) -->
        <div id="user-profile" class="fixed top-4 right-4 flex items-center z-40">
            <span id="user-name" class="mr-2 text-sm font-medium hidden sm:inline"></span>
            <button id="logout-button" class="bg-gray-200 text-gray-800 py-1 px-3 rounded-full text-sm hover:bg-gray-300 flex items-center">
                <span id="user-initial" class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center mr-2"></span>
                <span class="hidden sm:inline">Logout</span>
            </button>
    </div>
    
    <!-- Help button (fixed position) -->
    <button id="help-button" class="fixed bottom-4 right-4 bg-blue-600 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:bg-blue-700 z-40">
        <span class="text-2xl">?</span>
    </button>

        <!-- Game Details Edit Modal -->
        <div id="game-details-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
                <h2 class="text-xl font-semibold mb-4">Edit Game Details</h2>
                
                <div class="mb-6 border-b pb-6">
                    <h3 class="font-medium mb-3">Schedule Settings</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Monday Game Name</label>
                            <input type="text" id="edit-monday-name" class="w-full p-2 border rounded" value="Monday Night">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Monday Game Time</label>
                            <input type="text" id="edit-monday-time" class="w-full p-2 border rounded" value="8:00 PM - 12:00 AM">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Monday Game Date</label>
                            <input type="date" id="edit-monday-date" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Wednesday Game Name</label>
                            <input type="text" id="edit-wednesday-name" class="w-full p-2 border rounded" value="Wednesday Night">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Wednesday Game Time</label>
                            <input type="text" id="edit-wednesday-time" class="w-full p-2 border rounded" value="8:00 PM - 12:00 AM">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Wednesday Game Date</label>
                            <input type="date" id="edit-wednesday-date" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Saturday Game Name</label>
                            <input type="text" id="edit-saturday-name" class="w-full p-2 border rounded" value="Saturday Afternoon">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Saturday Game Time</label>
                            <input type="text" id="edit-saturday-time" class="w-full p-2 border rounded" value="2:00 PM - 6:00 PM">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Saturday Game Date</label>
                            <input type="date" id="edit-saturday-date" class="w-full p-2 border rounded">
                        </div>
                    </div>
                </div>
                
                <h3 class="font-medium mb-3">Game Settings</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Buy-in Amount ($)</label>
                        <input type="number" id="edit-buyin-amount" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Starting Chips</label>
                        <input type="number" id="edit-starting-chips" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Re-buys Policy</label>
                        <select id="edit-rebuys" class="w-full p-2 border rounded">
                            <option value="not-allowed">Not Allowed</option>
                            <option value="unlimited">Unlimited</option>
                            <option value="max-1">Allowed (max 1)</option>
                            <option value="max-2">Allowed (max 2)</option>
                            <option value="max-3">Allowed (max 3)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Location</label>
                        <input type="text" id="edit-location" class="w-full p-2 border rounded">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Notes</label>
                    <textarea id="edit-notes" class="w-full p-2 border rounded" rows="3"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="cancel-game-details" class="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600">Cancel</button>
                    <button id="save-game-details" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create a new modal for editing individual game details -->
    <div id="edit-single-game-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h2 class="text-xl font-semibold mb-4">Edit Game Details</h2>
            <input type="hidden" id="edit-game-day">
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-2">Game Name</label>
                <input type="text" id="edit-game-name" class="w-full p-2 border rounded">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-2">Game Time</label>
                <input type="text" id="edit-game-time" class="w-full p-2 border rounded">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-2">Game Date</label>
                <input type="date" id="edit-game-date" class="w-full p-2 border rounded">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-2">Buy-in Amount ($)</label>
                <input type="number" id="edit-game-buyin" class="w-full p-2 border rounded" min="0">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-2">Starting Chips</label>
                <input type="number" id="edit-game-chips" class="w-full p-2 border rounded" min="0">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-2">Rebuys</label>
                <select id="edit-game-rebuys" class="w-full p-2 border rounded">
                    <option value="none">Not Allowed</option>
                    <option value="unlimited">Unlimited</option>
                    <option value="max-1">Maximum 1</option>
                    <option value="max-2">Maximum 2</option>
                    <option value="max-3">Maximum 3</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-2">Location</label>
                <input type="text" id="edit-game-location" class="w-full p-2 border rounded">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-2">Notes</label>
                <textarea id="edit-game-notes" class="w-full p-2 border rounded" rows="3"></textarea>
            </div>
            
            <div class="flex justify-end mt-6">
                <button id="cancel-edit-game" class="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400 mr-2">Cancel</button>
                <button id="save-edit-game" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // Debugging mode - set to true to bypass Firebase auth for local testing
        const DEBUG_MODE = false;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBINgIvMfLG792XgTrz-0kNfQOy_OLeG-A",
            authDomain: "pm-account-550a5.firebaseapp.com",
            databaseURL: "https://pm-account-550a5-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pm-account-550a5",
            storageBucket: "pm-account-550a5.firebasestorage.app",
            messagingSenderId: "15759625104",
            appId: "1:15759625104:web:8f3799a900c5cf398bc115"
        };

        // Initialize Firebase variables
        let auth, database;
        
        // Initialize Firebase
        try {
            // Check if Firebase is already initialized
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialized successfully");
            }
            auth = firebase.auth();
            database = firebase.database();
            console.log("Firebase auth and database services initialized");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            
            // Don't automatically set DEBUG_MODE to true
            // Keep DEBUG_MODE as defined above
            console.log("Firebase initialization failed, but not enabling DEBUG_MODE");
            
            // Create mock auth and database objects
            auth = {
                signInWithEmailAndPassword: () => Promise.reject(new Error("Firebase auth not available")),
                createUserWithEmailAndPassword: () => Promise.reject(new Error("Firebase auth not available")),
                onAuthStateChanged: (callback) => callback(null),
                signOut: () => Promise.resolve()
            };
            
            database = {
                ref: () => ({
                    set: () => Promise.reject(new Error("Firebase database not available")),
                    once: () => Promise.reject(new Error("Firebase database not available"))
                })
            };
            
            if (!DEBUG_MODE) {
                alert("Error connecting to Firebase. Please check your internet connection and try again.");
            }
        }
        
        // Admin code for registration
        const ADMIN_CODE = "poker1234"; // Change this to a secure code

        // Authentication state variables
        let currentUser = null;
        let isAdmin = false;

        // Authentication functions
        function login(email, password) {
            const loginError = document.getElementById('login-error');
            loginError.classList.add('hidden');
            
            // Debug mode login - bypass Firebase
            if (DEBUG_MODE) {
                console.log("DEBUG MODE: Bypassing Firebase auth");
                // Simulated login
                currentUser = {
                    uid: "debug-user-id",
                    email: email,
                    displayName: email.split('@')[0],
                    updateProfile: () => Promise.resolve()
                };
                
                // Set admin if using the admin code as password
                isAdmin = (password === ADMIN_CODE);
                
                // Save mock user data
                if (!localStorage.getItem('debug_users')) {
                    localStorage.setItem('debug_users', JSON.stringify({}));
                }
                
                const debugUsers = JSON.parse(localStorage.getItem('debug_users'));
                if (!debugUsers[email]) {
                    debugUsers[email] = {
                        uid: "debug-user-id-" + Date.now(),
                        email: email,
                        name: email.split('@')[0],
                        isAdmin: isAdmin,
                        createdAt: new Date().toISOString()
                    };
                    localStorage.setItem('debug_users', JSON.stringify(debugUsers));
                } else {
                    isAdmin = debugUsers[email].isAdmin;
                }
                
                updateUIForUserRole();
                showApp();
                return;
            }
            
            // Normal Firebase login
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in successfully
                    currentUser = userCredential.user;
                    checkAdminStatus(currentUser);
                })
                .catch((error) => {
                    loginError.textContent = error.message;
                    loginError.classList.remove('hidden');
                });
        }

        function register(name, email, password, isAdminRegistration, adminCode) {
            const registerError = document.getElementById('register-error');
            registerError.classList.add('hidden');
            
            // Basic validation
            if (!name || !email || !password) {
                registerError.textContent = "Please fill in all required fields";
                registerError.classList.remove('hidden');
                return;
            }
            
            // Check if admin code is correct if attempting admin registration
            if (isAdminRegistration && adminCode !== ADMIN_CODE) {
                registerError.textContent = "Invalid admin code";
                registerError.classList.remove('hidden');
                return;
            }
            
            // Debug mode registration - bypass Firebase
            if (DEBUG_MODE) {
                console.log("DEBUG MODE: Bypassing Firebase auth for registration");
                
                // Simulated user
                currentUser = {
                    uid: "debug-user-id-" + Date.now(),
                    email: email,
                    displayName: name,
                    updateProfile: () => Promise.resolve()
                };
                
                // Save mock user data
                if (!localStorage.getItem('debug_users')) {
                    localStorage.setItem('debug_users', JSON.stringify({}));
                }
                
                const debugUsers = JSON.parse(localStorage.getItem('debug_users'));
                debugUsers[email] = {
                    uid: currentUser.uid,
                    email: email,
                    name: name,
                    isAdmin: isAdminRegistration,
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('debug_users', JSON.stringify(debugUsers));
                
                // Add user to players list if they don't exist already
                const playerExists = appData.players.some(player => player.email === email);
                if (!playerExists) {
                    appData.players.push({
                        id: Date.now().toString(),
                        name: name,
                        email: email,
                        phone: ""
                    });
                    saveData();
                }
                
                isAdmin = isAdminRegistration;
                updateUIForUserRole();
                showApp();
                return;
            }
            
            // Show loading state
            const registerButton = document.getElementById('register-button');
            const originalText = registerButton.textContent;
            registerButton.textContent = "Creating Account...";
            registerButton.disabled = true;
            
            // Normal Firebase registration
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log("User created successfully");
                    currentUser = userCredential.user;
                    
                    // Save additional user data to the database
                    return database.ref('users/' + currentUser.uid).set({
                        name: name,
                        email: email,
                        isAdmin: isAdminRegistration,
                        createdAt: new Date().toISOString()
                    });
                })
                .then(() => {
                    console.log("User data saved to database");
                    // Update display name
                    return currentUser.updateProfile({
                        displayName: name
                    });
                })
                .then(() => {
                    console.log("Display name updated");
                    isAdmin = isAdminRegistration;
                    
                    // Add user to players list if they don't exist already
                    const playerExists = appData.players.some(player => player.email === email);
                    if (!playerExists) {
                        appData.players.push({
                            id: Date.now().toString(),
                            name: name,
                            email: email,
                            phone: ""
                        });
                        saveData();
                    }
                    
                    showApp();
                })
                .catch((error) => {
                    console.error("Registration error:", error);
                    registerError.textContent = error.message;
                    registerError.classList.remove('hidden');
                    
                    // Reset button
                    registerButton.textContent = originalText;
                    registerButton.disabled = false;
                });
        }

        function logout() {
            auth.signOut()
                .then(() => {
                    hideApp();
                    showLoginScreen();
                })
                .catch((error) => {
                    console.error("Error signing out:", error);
                });
        }

        function checkAdminStatus(user) {
            if (!user) return Promise.resolve(false);
            
            return database.ref('users/' + user.uid).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    isAdmin = userData && userData.isAdmin === true;
                    updateUIForUserRole();
                    showApp();
                    return isAdmin;
                })
                .catch((error) => {
                    console.error("Error checking admin status:", error);
                    return false;
                });
        }

        function updateUIForUserRole() {
            // Admin can access all features
            // Players have limited access
            const adminOnlyElements = document.querySelectorAll('.admin-only');
            adminOnlyElements.forEach(el => {
                if (isAdmin) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
            
            // Update user display
            const userInitial = document.getElementById('user-initial');
            const userName = document.getElementById('user-name');
            
            if (currentUser && currentUser.displayName) {
                const initial = currentUser.displayName.charAt(0).toUpperCase();
                userInitial.textContent = initial;
                userName.textContent = currentUser.displayName;
            }
        }

        function showLoginScreen() {
            document.getElementById('login-container').classList.remove('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
        }

        function showRegisterScreen() {
            document.getElementById('login-container').classList.remove('hidden');
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        }

        function showApp() {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            // Load data from Firebase instead of localStorage
            loadDataFromFirebase();
        }

        function hideApp() {
            document.getElementById('app-container').classList.add('hidden');
            currentUser = null;
            isAdmin = false;
        }

        // Firebase data functions
        function loadDataFromFirebase() {
            if (!currentUser) return;
            
            // Debug mode - use localStorage only
            if (DEBUG_MODE) {
                console.log("DEBUG MODE: Loading data from localStorage only");
                loadData();
                updateUI();
                return;
            }
            
            // Load app data from shared location in Firebase
            database.ref('appData').once('value')
                .then((snapshot) => {
                    const firebaseData = snapshot.val();
                    if (firebaseData) {
                        appData = firebaseData;
                        
                        // Ensure data structure is valid after loading from Firebase
                        if (!appData.games) {
                            appData.games = {
                                monday: { 
                                    players: [],
                                    name: "Monday Night", 
                                    time: "8:00 PM - 12:00 AM",
                                    date: getNextDateForDay(1)
                                },
                                wednesday: { 
                                    players: [],
                                    name: "Wednesday Night", 
                                    time: "8:00 PM - 12:00 AM",
                                    date: getNextDateForDay(3)
                                },
                                saturday: { 
                                    players: [],
                                    name: "Saturday Afternoon", 
                                    time: "2:00 PM - 6:00 PM",
                                    date: getNextDateForDay(6)
                                }
                            };
                        } else {
                            // Make sure each day exists and has required properties
                            ['monday', 'wednesday', 'saturday'].forEach(day => {
                                if (!appData.games[day]) {
                                    appData.games[day] = { 
                                        players: [],
                                        name: capitalizeFirstLetter(day) + (day === 'saturday' ? ' Afternoon' : ' Night'),
                                        time: day === 'saturday' ? "2:00 PM - 6:00 PM" : "8:00 PM - 12:00 AM",
                                        date: getNextDateForDay(day === 'monday' ? 1 : day === 'wednesday' ? 3 : 6)
                                    };
                                } else {
                                    // Ensure players array exists
                                    if (!appData.games[day].players) {
                                        appData.games[day].players = [];
                                    }
                                    // Ensure name exists
                                    if (!appData.games[day].name) {
                                        appData.games[day].name = capitalizeFirstLetter(day) + (day === 'saturday' ? ' Afternoon' : ' Night');
                                    }
                                    // Ensure time exists
                                    if (!appData.games[day].time) {
                                        appData.games[day].time = day === 'saturday' ? "2:00 PM - 6:00 PM" : "8:00 PM - 12:00 AM";
                                    }
                                    // Ensure date exists
                                    if (!appData.games[day].date) {
                                        appData.games[day].date = getNextDateForDay(day === 'monday' ? 1 : day === 'wednesday' ? 3 : 6);
                                    }
                                }
                            });
                        }

                        // Ensure gameSettings exists
                        if (!appData.gameSettings) {
                            appData.gameSettings = {
                                buyinAmount: 50,
                                startingChips: 5000,
                                rebuys: "max-2",
                                location: "Main Street Poker Room",
                                notes: "Please arrive 15 minutes early. Bring your own drinks, snacks will be provided."
                            };
                        }
                        
                        if (!appData.players) appData.players = [];
                        if (!appData.gameHistory) appData.gameHistory = [];
                    } else {
                        // If no Firebase data, try localStorage as fallback
                        loadData();
                        // Then save to Firebase
                        saveDataToFirebase();
                    }
                    updateUI();
                })
                .catch((error) => {
                    console.error("Error loading Firebase data:", error);
                    // Fallback to localStorage
                    loadData();
                    updateUI();
                });
        }

        function saveDataToFirebase() {
            if (!currentUser) return;
            
            // Debug mode - skip Firebase save
            if (DEBUG_MODE) {
                console.log("DEBUG MODE: Skipping Firebase save");
                return;
            }
            
            // Save to shared location in Firebase
            database.ref('appData').set(appData)
                .catch((error) => {
                    console.error("Error saving to Firebase:", error);
                    // Fallback to localStorage
                    saveData();
                });
        }

        // Modify original saveData function to also save to Firebase
        const originalSaveData = saveData;
        function saveData() {
            // First try to save to Firebase
            if (currentUser) {
                saveDataToFirebase();
            }
            
            // Also save to localStorage as backup
            originalSaveData();
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            
            // Initialize UI
            updateUI();
            
            // Create the game edit modal
            createGameEditModal();
            
            // Add global click listener for edit buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('edit-game-details')) {
                    console.log("Edit game details button clicked");
                    const gameDay = e.target.getAttribute('data-day');
                    console.log("Game day:", gameDay);
                    
                    if (gameDay && appData.games[gameDay]) {
                        const game = appData.games[gameDay];
                        const modal = document.getElementById('edit-single-game-modal');
                        
                        // Set the hidden game day field
                        document.getElementById('edit-game-day').value = gameDay;
                        
                        // Populate form fields with current game values
                        document.getElementById('edit-game-name').value = game.name || '';
                        document.getElementById('edit-game-time').value = game.time || '';
                        document.getElementById('edit-game-date').value = game.date || '';
                        document.getElementById('edit-game-buyin').value = game.buyinAmount || 50;
                        document.getElementById('edit-game-chips').value = game.startingChips || 5000;
                        document.getElementById('edit-game-rebuys').value = game.rebuys || 'none';
                        document.getElementById('edit-game-location').value = game.location || '';
                        document.getElementById('edit-game-notes').value = game.notes || '';
                        
                        // Open the modal
                        modal.classList.add('active');
                    }
                }
            });
            
            // Auth state change listener and other existing code...
            // ... existing code ...
            
            // Login form
            document.getElementById('login-button').addEventListener('click', function(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                login(email, password);
            });
            
            // Register form
            document.getElementById('register-button').addEventListener('click', function(e) {
                e.preventDefault();
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const isAdminRegistration = document.getElementById('register-admin').checked;
                const adminCode = document.getElementById('admin-code').value;
                register(name, email, password, isAdminRegistration, adminCode);
            });
            
            // Toggle between login and register
            document.getElementById('show-register').addEventListener('click', function(e) {
                e.preventDefault();
                showRegisterScreen();
            });
            
            document.getElementById('show-login').addEventListener('click', function(e) {
                e.preventDefault();
                showLoginScreen();
            });
            
            // Admin code toggle
            document.getElementById('register-admin').addEventListener('change', function() {
                const adminCodeContainer = document.getElementById('admin-code-container');
                if (this.checked) {
                    adminCodeContainer.classList.remove('hidden');
                } else {
                    adminCodeContainer.classList.add('hidden');
                }
            });
            
            // Logout button
            document.getElementById('logout-button').addEventListener('click', function(e) {
                e.preventDefault();
                logout();
            });
            
            // Load saved data
            loadData();
            
            // Set up tab navigation
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    showTab(tab);
                });
            });
            
            // Setup all other event listeners
            setupEventListeners();
            
            // Update UI
            updateUI();
        });

        // Application data
        let appData = {
            players: [],
            games: {
                monday: { 
                    players: [],
                    name: "Monday Night",
                    time: "8:00 PM - 12:00 AM",
                    date: getNextDateForDay(1), // Monday = 1
                    buyinAmount: 50,
                    startingChips: 5000,
                    rebuys: "max-2",
                    location: "Main Street Poker Room",
                    notes: "Please arrive 15 minutes early. Bring your own drinks, snacks will be provided."
                },
                wednesday: { 
                    players: [],
                    name: "Wednesday Night",
                    time: "8:00 PM - 12:00 AM",
                    date: getNextDateForDay(3), // Wednesday = 3
                    buyinAmount: 50,
                    startingChips: 5000,
                    rebuys: "max-2",
                    location: "Main Street Poker Room",
                    notes: "Please arrive 15 minutes early. Bring your own drinks, snacks will be provided."
                },
                saturday: { 
                    players: [],
                    name: "Saturday Afternoon",
                    time: "2:00 PM - 6:00 PM",
                    date: getNextDateForDay(6), // Saturday = 6
                    buyinAmount: 50,
                    startingChips: 5000,
                    rebuys: "max-2",
                    location: "Main Street Poker Room",
                    notes: "Please arrive 15 minutes early. Bring your own drinks, snacks will be provided."
                }
            },
            currentGame: null,
            gameHistory: []
        };

        // Helper function to get next date for a specific day of the week
        function getNextDateForDay(dayOfWeek) {
            const today = new Date();
            const currentDay = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const daysUntilNext = (dayOfWeek - currentDay + 7) % 7;
            
            const nextDate = new Date(today);
            nextDate.setDate(today.getDate() + daysUntilNext);
            
            return nextDate.toISOString().split('T')[0]; // Format as YYYY-MM-DD
        }

        // Load data from localStorage if exists
        function loadData() {
            const savedData = localStorage.getItem('pokerAppData');
            if (savedData) {
                try {
                    appData = JSON.parse(savedData);
                    // Ensure structure is valid
                    if (!appData.games) {
                        appData.games = {
                            monday: { 
                                players: [],
                                name: "Monday Night",
                                time: "8:00 PM - 12:00 AM",
                                date: getNextDateForDay(1)
                            },
                            wednesday: { 
                                players: [],
                                name: "Wednesday Night",
                                time: "8:00 PM - 12:00 AM",
                                date: getNextDateForDay(3)
                            },
                            saturday: { 
                                players: [],
                                name: "Saturday Afternoon",
                                time: "2:00 PM - 6:00 PM",
                                date: getNextDateForDay(6)
                            }
                        };
                    }
                    
                    // Ensure each day has all required properties
                    ['monday', 'wednesday', 'saturday'].forEach(day => {
                        if (!appData.games[day]) {
                            appData.games[day] = { 
                                players: [],
                                name: capitalizeFirstLetter(day) + (day === 'saturday' ? ' Afternoon' : ' Night'),
                                time: day === 'saturday' ? "2:00 PM - 6:00 PM" : "8:00 PM - 12:00 AM",
                                date: getNextDateForDay(day === 'monday' ? 1 : day === 'wednesday' ? 3 : 6)
                            };
                        }
                        if (!appData.games[day].players) {
                            appData.games[day].players = [];
                        }
                        if (!appData.games[day].name) {
                            appData.games[day].name = capitalizeFirstLetter(day) + (day === 'saturday' ? ' Afternoon' : ' Night');
                        }
                        if (!appData.games[day].time) {
                            appData.games[day].time = day === 'saturday' ? "2:00 PM - 6:00 PM" : "8:00 PM - 12:00 AM";
                        }
                        if (!appData.games[day].date) {
                            appData.games[day].date = getNextDateForDay(day === 'monday' ? 1 : day === 'wednesday' ? 3 : 6);
                        }
                    });

                    // Ensure gameSettings object exists
                    if (!appData.gameSettings) {
                        appData.gameSettings = {
                            buyinAmount: 50,
                            startingChips: 5000,
                            rebuys: "max-2",
                            location: "Main Street Poker Room",
                            notes: "Please arrive 15 minutes early. Bring your own drinks, snacks will be provided."
                        };
                    }
                    
                    if (!appData.players) {
                        appData.players = [];
                    }
                    if (!appData.gameHistory) {
                        appData.gameHistory = [];
                    }
                    updateUI();
                } catch (e) {
                    console.error("Error loading saved data:", e);
                    // Reset to default if corrupt
                    appData = {
                        players: [],
                        games: {
                            monday: { 
                                players: [],
                                name: "Monday Night",
                                time: "8:00 PM - 12:00 AM",
                                date: getNextDateForDay(1)
                            },
                            wednesday: { 
                                players: [],
                                name: "Wednesday Night",
                                time: "8:00 PM - 12:00 AM",
                                date: getNextDateForDay(3)
                            },
                            saturday: { 
                                players: [],
                                name: "Saturday Afternoon",
                                time: "2:00 PM - 6:00 PM",
                                date: getNextDateForDay(6)
                            }
                        },
                        gameSettings: {
                            buyinAmount: 50,
                            startingChips: 5000,
                            rebuys: "max-2",
                            location: "Main Street Poker Room",
                            notes: "Please arrive 15 minutes early. Bring your own drinks, snacks will be provided."
                        },
                        currentGame: null,
                        gameHistory: []
                    };
                }
            }
        }

        // Save data to localStorage and Firebase
        function saveData() {
            try {
                // Save to localStorage as backup
                localStorage.setItem('pokerAppData', JSON.stringify(appData));
                
                // Save to Firebase if user is logged in
                if (currentUser) {
                    saveDataToFirebase();
                }
            } catch (e) {
                console.error("Error saving data:", e);
                alert("Error saving data. Please try again.");
            }
        }

        // Update UI elements based on current data
        function updateUI() {
            updatePlayerList();
            updateGameSchedule();
            updateCurrentGame();
            updateGameHistory();
            updatePlayerActionsTable();
            updateLeaderboard();
            updateUIForUserRole();
            updateGameSelector(); // Update the game selector dropdown
            
            // Update the current game player selector if a game is active
            if (appData.currentGame) {
                updateCurrentGamePlayerSelector();
            }
        }

        // Update player list in the UI
        function updatePlayerList() {
            const playersList = document.getElementById('players-list');
            if (!playersList) return;
            
            playersList.innerHTML = '';
            
            appData.players.forEach(player => {
                const row = document.createElement('tr');
                
                // Different UI for admin vs regular users
                if (isAdmin) {
                    row.innerHTML = `
                        <td class="py-2 px-3">${player.name}</td>
                        <td class="py-2 px-3">${player.email || '-'}</td>
                        <td class="py-2 px-3 text-right">
                            <button class="edit-player bg-blue-500 text-white py-1 px-2 rounded text-xs hover:bg-blue-600 mr-1" data-player-id="${player.id}">Edit</button>
                            <button class="delete-player bg-red-500 text-white py-1 px-2 rounded text-xs hover:bg-red-600" data-player-id="${player.id}">Delete</button>
                        </td>
                    `;
                } else {
                    row.innerHTML = `
                        <td class="py-2 px-3">${player.name}</td>
                        <td class="py-2 px-3">${player.email || '-'}</td>
                        <td class="py-2 px-3"></td>
                    `;
                }
                
                playersList.appendChild(row);
            });
            
            // Update player selectors
            updatePlayerSelectors();
        }

        // Update game schedule in the UI
        function updateGameSchedule() {
            // Update player selectors for admin functionality
            updatePlayerSelectors();
            
            // Update weekly game schedules
            ['monday', 'wednesday', 'saturday'].forEach(day => {
                const playersList = document.getElementById(`${day}-players`);
                const seatsCounter = document.getElementById(`${day}-seats`);
                
                if (!playersList || !seatsCounter) return;
                
                // Update game name and time in the UI
                const gameCard = document.querySelector(`.border.rounded-lg.p-4.hover\\:shadow-md.transition:nth-of-type(${day === 'monday' ? 1 : day === 'wednesday' ? 2 : 3})`);
                const gameNameElement = gameCard.querySelector('h3.font-medium');
                const gameTimeElement = gameCard.querySelector('p.text-sm.text-gray-600.mb-2');
                
                // Add display of date if not already present
                let gameDateElement = gameCard.querySelector('.game-date');
                if (!gameDateElement) {
                    gameDateElement = document.createElement('p');
                    gameDateElement.className = 'text-sm text-gray-600 mb-2 game-date';
                    if (gameTimeElement) {
                        gameTimeElement.parentNode.insertBefore(gameDateElement, gameTimeElement.nextSibling);
                    }
                }
                
                // Add game details section if not already present
                let gameDetailsElement = gameCard.querySelector('.game-details');
                if (!gameDetailsElement) {
                    gameDetailsElement = document.createElement('div');
                    gameDetailsElement.className = 'mt-3 text-sm game-details';
                    gameDetailsElement.innerHTML = `
                        <p class="font-medium mb-1">Game Details:</p>
                        <ul class="list-disc pl-5 mb-3">
                            <li>Buy-in: $<span class="buyin-amount"></span></li>
                            <li>Starting Chips: <span class="starting-chips"></span></li>
                            <li>Rebuys: <span class="rebuys-policy"></span></li>
                            <li>Location: <span class="location"></span></li>
                        </ul>
                        <p class="font-medium mb-1">Notes:</p>
                        <p class="notes text-xs text-gray-600 mb-3"></p>
                        <button class="edit-game-details w-full bg-green-600 text-white py-1 rounded text-xs hover:bg-green-700 mb-3" data-day="${day}">Edit Game Details</button>
                    `;
                    
                    // Insert before the Players section
                    const playersSection = gameCard.querySelector('.mt-3.text-sm');
                    if (playersSection) {
                        gameCard.insertBefore(gameDetailsElement, playersSection);
                    } else {
                        gameCard.appendChild(gameDetailsElement);
                    }
                }
                
                if (gameNameElement) {
                    gameNameElement.textContent = appData.games[day].name || capitalizeFirstLetter(day) + (day === 'saturday' ? ' Afternoon' : ' Night');
                }
                
                if (gameTimeElement) {
                    gameTimeElement.textContent = appData.games[day].time || (day === 'saturday' ? "2:00 PM - 6:00 PM" : "8:00 PM - 12:00 AM");
                }
                
                if (gameDateElement) {
                    const displayDate = formatDateNicely(appData.games[day].date);
                    gameDateElement.textContent = displayDate;
                }
                
                // Update game details
                if (gameDetailsElement) {
                    const gameSettings = appData.games[day];
                    const buyinEl = gameDetailsElement.querySelector('.buyin-amount');
                    const chipsEl = gameDetailsElement.querySelector('.starting-chips');
                    const rebuysEl = gameDetailsElement.querySelector('.rebuys-policy');
                    const locationEl = gameDetailsElement.querySelector('.location');
                    const notesEl = gameDetailsElement.querySelector('.notes');
                    
                    if (buyinEl) buyinEl.textContent = gameSettings.buyinAmount;
                    if (chipsEl) chipsEl.textContent = gameSettings.startingChips;
                    
                    if (rebuysEl) {
                        let rebuysText = 'Not Allowed';
                        if (gameSettings.rebuys === 'unlimited') rebuysText = 'Unlimited';
                        else if (gameSettings.rebuys === 'max-1') rebuysText = 'Allowed (max 1)';
                        else if (gameSettings.rebuys === 'max-2') rebuysText = 'Allowed (max 2)';
                        else if (gameSettings.rebuys === 'max-3') rebuysText = 'Allowed (max 3)';
                        rebuysEl.textContent = rebuysText;
                    }
                    
                    if (locationEl) locationEl.textContent = gameSettings.location;
                    if (notesEl) notesEl.textContent = gameSettings.notes;
                }
                
                playersList.innerHTML = '';
                
                // Get players for this day
                const gamePlayers = appData.games[day].players || [];
                
                // Update player count - no limit on players now
                const regularPlayerCount = gamePlayers.length;
                seatsCounter.textContent = regularPlayerCount + "/10+";  // Show "10+" to indicate we can exceed 10
                
                // Update players list with visual indication of reserves
                gamePlayers.forEach((playerId, index) => {
                    const player = appData.players.find(p => p.id === playerId);
                    if (player) {
                        const listItem = document.createElement('li');
                        
                        // Mark reserves (players beyond 10) with different styling
                        const isReserve = index >= 10;
                        
                        if (isReserve) {
                            listItem.innerHTML = `<span class="text-amber-600">${player.name} (Reserve)</span>`;
                        } else {
                            listItem.textContent = player.name;
                        }
                        
                        // Add remove button if user is admin or this is the current user
                        if (isAdmin || (currentUser && player.email === currentUser.email)) {
                            const removeBtn = document.createElement('button');
                            removeBtn.textContent = '×';
                            removeBtn.className = 'ml-2 text-red-500 font-bold hover:text-red-700';
                            removeBtn.setAttribute('data-day', day);
                            removeBtn.setAttribute('data-player-id', player.id);
                            removeBtn.onclick = function() {
                                removePlayerFromGame(day, player.id);
                            };
                            listItem.appendChild(removeBtn);
                        }
                        
                        playersList.appendChild(listItem);
                    }
                });
                
                // Update book seat button - always enabled now since we allow reserves
                const bookButton = document.querySelector(`.book-game[data-day="${day}"]`);
                if (bookButton) {
                    // If 10+ players, change button text to indicate booking as reserve
                    if (gamePlayers.length >= 10) {
                        bookButton.textContent = "Book as Reserve";
                        bookButton.classList.add('bg-amber-600');
                        bookButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        bookButton.classList.add('hover:bg-amber-700');
                    } else {
                        bookButton.textContent = "Book Seat";
                        bookButton.classList.remove('bg-amber-600', 'hover:bg-amber-700');
                        bookButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }
                    
                    // Always enabled
                    bookButton.disabled = false;
                    bookButton.classList.remove('bg-gray-400');
                }
            });
        }
        
        // Format date for display
        function formatDateNicely(dateString) {
            if (!dateString) return "";
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return ""; // Invalid date
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
        
        // Helper function to remove a player from a game
        function removePlayerFromGame(day, playerId) {
            if (!appData.games[day]) return;
            
            const index = appData.games[day].players.findIndex(id => id === playerId);
            if (index !== -1) {
                appData.games[day].players.splice(index, 1);
                saveData();
                updateGameSchedule();
            }
        }

        // Update current game UI
        function updateCurrentGame() {
            const gameTab = document.getElementById('game');
            if (!gameTab) return;
            
            const noCurrentGame = document.getElementById('no-current-game');
            const currentGameInfo = document.getElementById('current-game-info');
            const playerActions = document.getElementById('player-actions');
            
            if (!appData.currentGame) {
                // No active game
                if (noCurrentGame) noCurrentGame.classList.remove('hidden');
                if (currentGameInfo) currentGameInfo.classList.add('hidden');
                if (playerActions) playerActions.classList.add('hidden');
                return;
            }
            
            // Show game info, hide no game message
            if (noCurrentGame) noCurrentGame.classList.add('hidden');
            if (currentGameInfo) currentGameInfo.classList.remove('hidden');
            if (playerActions) playerActions.classList.remove('hidden');
            
            // Update game details
            const currentGameDay = document.getElementById('current-game-day');
            const currentGameDate = document.getElementById('current-game-date');
            const currentGamePlayers = document.getElementById('current-game-players');
            
            if (currentGameDay) {
                // Use the game name if available, otherwise use the capitalized day
                currentGameDay.textContent = appData.currentGame.name || 
                    appData.games[appData.currentGame.day]?.name || 
                    capitalizeFirstLetter(appData.currentGame.day);
            }
            
            if (currentGameDate) {
                currentGameDate.textContent = formatDate(appData.currentGame.date);
            }
            
            if (currentGamePlayers) {
                // Clear the current content
                currentGamePlayers.innerHTML = '';
                
                // Get players
                if (!appData.currentGame.players || appData.currentGame.players.length === 0) {
                    currentGamePlayers.textContent = 'No players';
                    return;
                }
                
                // Create a list to display players with reserves styled differently
                const playerList = document.createElement('ul');
                playerList.className = 'list-disc pl-5';
                
                appData.currentGame.players.forEach((playerId, index) => {
                    const player = appData.players.find(p => p.id === playerId);
                    if (!player) return;
                    
                    const isReserve = index >= 10;
                    
                    const listItem = document.createElement('li');
                    if (isReserve) {
                        listItem.innerHTML = `<span class="text-amber-600">${player.name} (Reserve)</span>`;
                    } else {
                        listItem.textContent = player.name;
                    }
                    
                    playerList.appendChild(listItem);
                });
                
                currentGamePlayers.appendChild(playerList);
            }
            
            // Update player actions table
            updatePlayerActionsTable();
        }
        
        // Update game history UI
        function updateGameHistory() {
            const historyList = document.getElementById('game-history');
            if (!historyList) return;
            
            historyList.innerHTML = '';
            
            if (appData.gameHistory && appData.gameHistory.length > 0) {
                appData.gameHistory.forEach((game, index) => {
                    const row = document.createElement('tr');
                    
                    // Ensure arrays exist to prevent errors
                    if (!game.buyins) game.buyins = [];
                    if (!game.chips) game.chips = [];
                    
                    // Calculate total buyins and chips
                    const totalBuyins = game.buyins.reduce((sum, buyin) => sum + buyin.amount, 0);
                    const totalChips = game.chips.reduce((sum, chip) => sum + chip.amount, 0);
                    const dealerTips = parseInt(game.dealerTips) || 0;
                    const balance = (totalChips + dealerTips) - totalBuyins;
                    
                    // Use the game name if available, otherwise use the capitalized day
                    const gameName = game.name || capitalizeFirstLetter(game.day);
                    
                    row.innerHTML = `
                        <td class="py-2 px-3">${formatDate(game.date)}</td>
                        <td class="py-2 px-3">${gameName}</td>
                        <td class="py-2 px-3 text-center">${game.players ? game.players.length : 0}</td>
                        <td class="py-2 px-3 text-right">
                            <div class="flex justify-end space-x-1">
                                <button class="view-results bg-blue-500 text-white py-1 px-2 rounded text-xs hover:bg-blue-600" data-index="${index}">Results</button>
                                <button class="delete-game bg-red-500 text-white py-1 px-2 rounded text-xs hover:bg-red-600 admin-only" data-index="${index}">Delete</button>
                            </div>
                        </td>
                    `;
                    
                    historyList.appendChild(row);
                });
                
                // Add event listeners for view buttons
                document.querySelectorAll('.view-results').forEach(button => {
                    button.addEventListener('click', function() {
                        const gameIndex = parseInt(this.getAttribute('data-index'));
                        showGameResults(gameIndex);
                    });
                });
            } else {
                // No game history
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="4" class="py-4 text-center text-gray-500">No games recorded yet</td>
                `;
                historyList.appendChild(row);
            }
        }
        
        // Update leaderboard UI
        function updateLeaderboard() {
            const leaderboardTable = document.getElementById('leaderboard');
            if (!leaderboardTable) return;
            
            leaderboardTable.innerHTML = '';
            
            if (!appData.gameHistory || appData.gameHistory.length === 0) {
                // No game history
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="py-4 text-center text-gray-500">No games recorded yet</td>
                `;
                leaderboardTable.appendChild(row);
                return;
            }
            
            // Calculate player stats
            const playerStats = {};
            
            appData.gameHistory.forEach(game => {
                // Ensure game has required arrays
                if (!game.players) game.players = [];
                if (!game.buyins) game.buyins = [];
                if (!game.chips) game.chips = [];
                
                // Process each player in the game
                game.players.forEach(playerId => {
                    // Initialize player stats if not exist
                    if (!playerStats[playerId]) {
                        const player = appData.players.find(p => p.id === playerId);
                        if (!player) return;
                        
                        playerStats[playerId] = {
                            id: playerId,
                            name: player.name,
                            gamesPlayed: 0,
                            totalBuyins: 0,
                            totalChips: 0,
                            totalProfit: 0,
                            wins: 0,
                            losses: 0
                        };
                    }
                    
                    // Calculate profit/loss for this game
                    const buyins = game.buyins.filter(b => b.playerId === playerId);
                    const totalBuyin = buyins.reduce((sum, b) => sum + b.amount, 0);
                    
                    const chipsRecord = game.chips.find(c => c.playerId === playerId);
                    const endChips = chipsRecord ? chipsRecord.amount : 0;
                    
                    const profitLoss = endChips - totalBuyin;
                    
                    // Update player stats
                    playerStats[playerId].gamesPlayed++;
                    playerStats[playerId].totalBuyins += totalBuyin;
                    playerStats[playerId].totalChips += endChips;
                    playerStats[playerId].totalProfit += profitLoss;
                    
                    if (profitLoss > 0) {
                        playerStats[playerId].wins++;
                    } else if (profitLoss < 0) {
                        playerStats[playerId].losses++;
                    }
                });
            });
            
            // Convert to array and sort by total profit
            const statsArray = Object.values(playerStats);
            statsArray.sort((a, b) => b.totalProfit - a.totalProfit);
            
            // Populate leaderboard
            statsArray.forEach((stats, index) => {
                const row = document.createElement('tr');
                
                const winRate = stats.gamesPlayed > 0 ? Math.round((stats.wins / stats.gamesPlayed) * 100) : 0;
                
                row.innerHTML = `
                    <td class="py-2 px-2 sm:px-3 text-left">${stats.name}</td>
                    <td class="py-2 px-2 sm:px-3 text-right">${stats.gamesPlayed}</td>
                    <td class="py-2 px-2 sm:px-3 text-right">$${stats.totalBuyins}</td>
                    <td class="py-2 px-2 sm:px-3 text-right">$${stats.totalChips}</td>
                    <td class="py-2 px-2 sm:px-3 text-right ${stats.totalProfit >= 0 ? 'text-green-600' : 'text-red-600'}">$${stats.totalProfit}</td>
                    <td class="py-2 px-2 sm:px-3 text-right">${winRate}%</td>
                `;
                
                leaderboardTable.appendChild(row);
            });
        }

        // Update player selection checkboxes for each game day
        function updatePlayerSelectors() {
            // Days to update
            const days = ['monday', 'wednesday', 'saturday'];
            
            days.forEach(day => {
                const checkboxContainer = document.getElementById(`${day}-player-checkboxes`);
                if (!checkboxContainer) return;
                
                // Clear existing checkboxes
                checkboxContainer.innerHTML = '';
                
                // Get players already in this game
                const gamePlayers = appData.games[day].players || [];
                
                if (appData.players.length === 0) {
                    // No players exist yet
                    checkboxContainer.innerHTML = '<p class="text-sm text-gray-500">No players available. Add players in the Players tab first.</p>';
                    return;
                }
                
                // Add a checkbox for each player
                appData.players.forEach(player => {
                    // Check if player is already in the game
                    const isInGame = gamePlayers.includes(player.id);
                    // Check if player would be a reserve (over 10 players)
                    const wouldBeReserve = gamePlayers.length >= 10;
                    
                    const checkboxItem = document.createElement('div');
                    checkboxItem.className = 'flex items-center';
                    
                    // Don't show checkbox if player is already in the game
                    if (isInGame) {
                        // Check if this player is a reserve (index >= 10)
                        const playerIndex = gamePlayers.indexOf(player.id);
                        const isReserve = playerIndex >= 10;
                        
                        checkboxItem.innerHTML = `
                            <span class="text-sm ${isReserve ? 'text-amber-600' : 'text-gray-500'} ml-6">
                                ${player.name} (${isReserve ? 'reserve' : 'already in game'})
                            </span>
                        `;
                    } else {
                        checkboxItem.innerHTML = `
                            <input type="checkbox" id="${day}-player-${player.id}" 
                                class="player-checkbox mr-2" 
                                data-player-id="${player.id}" 
                                data-day="${day}">
                            <label for="${day}-player-${player.id}" class="text-sm">
                                ${player.name}${wouldBeReserve ? ' <span class="text-xs text-amber-600">(will be reserve)</span>' : ''}
                            </label>
                        `;
                    }
                    
                    checkboxContainer.appendChild(checkboxItem);
                });
            });
        }

        // Update player actions table
        function updatePlayerActionsTable() {
            const playerActionsTable = document.getElementById('player-actions-table');
            if (!playerActionsTable || !appData.currentGame) return;
            
            playerActionsTable.innerHTML = '';
            
            let totalBuyins = 0;
            let totalChips = 0;
            
            // Ensure arrays exist to prevent filter/find errors
            if (!appData.currentGame.buyins) appData.currentGame.buyins = [];
            if (!appData.currentGame.chips) appData.currentGame.chips = [];
            
            appData.currentGame.players.forEach(playerId => {
                const player = appData.players.find(p => p.id === playerId);
                if (!player) return;

                // Get total buy-ins for this player
                const buyins = appData.currentGame.buyins.filter(b => b.playerId === playerId);
                const totalBuyin = buyins.reduce((sum, b) => sum + b.amount, 0);
                totalBuyins += totalBuyin;
                
                // Get end chips for this player
                const chipsRecord = appData.currentGame.chips.find(c => c.playerId === playerId);
                const endChips = chipsRecord ? chipsRecord.amount : 0;
                totalChips += endChips;
                
                const row = document.createElement('tr');
                
                // Different UI based on whether user is admin or regular player
                if (isAdmin) {
                    row.innerHTML = `
                        <td class="py-2 px-2 sm:px-3">${player.name}</td>
                        <td class="py-2 px-2 sm:px-3 text-right">
                            ${totalBuyin > 0 ? '$' + totalBuyin : '-'}
                            <button class="add-buyin ml-2 bg-blue-500 text-white py-1 px-1 sm:px-2 rounded text-xs hover:bg-blue-600 action-btn" data-player-id="${player.id}">+Buy</button>
                        </td>
                        <td class="py-2 px-2 sm:px-3 text-right">
                            ${endChips ? '$' + endChips : '-'}
                            <button class="record-chips ml-2 bg-blue-500 text-white py-1 px-1 sm:px-2 rounded text-xs hover:bg-blue-600 action-btn" data-player-id="${player.id}">+Chips</button>
                        </td>
                        <td class="py-2 px-2 sm:px-3 text-right">
                            <div class="flex flex-col sm:flex-row justify-end gap-1">
                                ${buyins.length > 0 ? `<button class="delete-buyin bg-red-500 text-white py-1 px-1 sm:px-2 rounded text-xs hover:bg-red-600 action-btn" data-player-id="${player.id}">-Buy</button>` : ''}
                                ${endChips ? `<button class="delete-chips bg-red-500 text-white py-1 px-1 sm:px-2 rounded text-xs hover:bg-red-600 action-btn" data-player-id="${player.id}">-Chips</button>` : ''}
                            </div>
                        </td>
                    `;
                } else {
                    // For regular players - view only
                    row.innerHTML = `
                        <td class="py-2 px-2 sm:px-3">${player.name}</td>
                        <td class="py-2 px-2 sm:px-3 text-right">${totalBuyin > 0 ? '$' + totalBuyin : '-'}</td>
                        <td class="py-2 px-2 sm:px-3 text-right">${endChips ? '$' + endChips : '-'}</td>
                        <td class="py-2 px-2 sm:px-3 text-right"></td>
                    `;
                    
                    // If this is the current logged-in player, allow them to record their own chips
                    if (currentUser && player.email === currentUser.email) {
                        const chipsCell = row.cells[2];
                        const actionsCell = row.cells[3];
                        
                        if (!endChips) {
                            chipsCell.innerHTML = `
                                ${endChips ? '$' + endChips : '-'}
                                <button class="record-chips ml-2 bg-blue-500 text-white py-1 px-1 sm:px-2 rounded text-xs hover:bg-blue-600 action-btn" data-player-id="${player.id}">+Chips</button>
                            `;
                        } else {
                            actionsCell.innerHTML = `
                                <div class="flex justify-end">
                                    <button class="delete-chips bg-red-500 text-white py-1 px-1 sm:px-2 rounded text-xs hover:bg-red-600 action-btn" data-player-id="${player.id}">Edit Chips</button>
                                </div>
                            `;
                        }
                    }
                }
                
                playerActionsTable.appendChild(row);
            });

            // After adding all rows, add event listeners to all buttons in the table
            playerActionsTable.querySelectorAll('.delete-buyin').forEach(button => {
                button.addEventListener('click', function() {
                    const playerId = this.getAttribute('data-player-id');
                    
                    if (playerId && appData.currentGame.buyins.length > 0) {
                        // Find the most recent buy-in for this player
                        const playerBuyins = appData.currentGame.buyins.filter(b => b.playerId === playerId);
                        if (playerBuyins.length > 0) {
                            // Sort by timestamp to get the most recent one
                            playerBuyins.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                            const mostRecentBuyin = playerBuyins[0];
                            
                            // Find the index of this buyin in the original array
                            const buyinIndex = appData.currentGame.buyins.findIndex(b => b.id === mostRecentBuyin.id);
                            
                            if (buyinIndex !== -1) {
                                // Remove the buyin
                                appData.currentGame.buyins.splice(buyinIndex, 1);
                                saveData();
                                updatePlayerActionsTable();
                            }
                        }
                    }
                });
            });
            
            // Get dealer tips
            const dealerTips = parseInt(appData.currentGame.dealerTips) || 0;
            
            // Update totals (including dealer tips in total chips)
            document.getElementById('total-buyins').textContent = '$' + totalBuyins;
            document.getElementById('total-chips').textContent = '$' + (totalChips + dealerTips);
            
            // Calculate and update final balance
            const finalBalance = (totalChips + dealerTips) - totalBuyins;
            const differenceElement = document.getElementById('total-difference');
            if (differenceElement) {
                differenceElement.textContent = '$' + finalBalance;
                differenceElement.className = `py-2 px-2 sm:px-3 text-right ${finalBalance >= 0 ? 'text-green-600' : 'text-red-600'}`;
            }
        }

        // Show a specific tab
        function showTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.getAttribute('data-tab') === tabId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Add other button event listeners
        function setupEventListeners() {
            // Add dynamic event handlers for action buttons that are added after DOM load
            document.addEventListener('click', function(e) {
                // Buy-in button
                if (e.target.classList.contains('add-buyin')) {
                    const playerId = e.target.getAttribute('data-player-id');
                    const amount = parseInt(document.getElementById('buyin-amount').value) || 0;
                    
                    if (playerId && amount > 0) {
                        // Add buyin
                        appData.currentGame.buyins.push({
                            id: Date.now().toString(),
                            playerId: playerId,
                            amount: amount,
                            timestamp: new Date().toISOString()
                        });
                        
                        saveData();
                        updatePlayerActionsTable();
                    }
                }
                
                // Record chips button
                else if (e.target.classList.contains('record-chips')) {
                    const playerId = e.target.getAttribute('data-player-id');
                    const amount = parseInt(document.getElementById('chips-amount').value) || 0;
                    
                    if (playerId && amount >= 0) {
                        // Check if chips record exists
                        const existingRecord = appData.currentGame.chips.find(c => c.playerId === playerId);
                        
                        if (existingRecord) {
                            existingRecord.amount = amount;
                        } else {
                            appData.currentGame.chips.push({
                                playerId: playerId,
                                amount: amount,
                                timestamp: new Date().toISOString()
                            });
                        }
                        
                        saveData();
                        updatePlayerActionsTable();
                        
                        // Clear input
                        document.getElementById('chips-amount').value = '';
                    }
                }
                
                // Delete chips button
                else if (e.target.classList.contains('delete-chips')) {
                    const playerId = e.target.getAttribute('data-player-id');
                    
                    if (playerId) {
                        // Remove chips record
                        appData.currentGame.chips = appData.currentGame.chips
                            .filter(c => c.playerId !== playerId);
                        
                        saveData();
                        updatePlayerActionsTable();
                    }
                }
                
                // Edit/delete player buttons
                else if (e.target.classList.contains('edit-player')) {
                    const playerId = e.target.getAttribute('data-player-id');
                    const player = appData.players.find(p => p.id === playerId);
                    
                    if (player) {
                        // For simplicity, just prompt for a new name
                        const newName = prompt('Edit player name:', player.name);
                        if (newName && newName.trim() !== '') {
                            player.name = newName;
                            saveData();
                            updatePlayerList();
                        }
                    }
                }
                else if (e.target.classList.contains('delete-player')) {
                    const playerId = e.target.getAttribute('data-player-id');
                    
                    if (playerId && confirm('Are you sure you want to delete this player?')) {
                        // Remove player
                        appData.players = appData.players.filter(p => p.id !== playerId);
                        
                        // Also remove from games
                        Object.keys(appData.games).forEach(day => {
                            appData.games[day].players = appData.games[day].players.filter(id => id !== playerId);
                        });
                        
                        saveData();
                        updatePlayerList();
                        updateGameSchedule();
                    }
                }
                
                // View game results button
                else if (e.target.classList.contains('view-results')) {
                    const gameIndex = parseInt(e.target.getAttribute('data-index'));
                    
                    if (!isNaN(gameIndex) && gameIndex >= 0 && gameIndex < appData.gameHistory.length) {
                        showGameResults(gameIndex);
                    }
                }
                
                // Delete game button
                else if (e.target.classList.contains('delete-game')) {
                    const gameIndex = parseInt(e.target.getAttribute('data-index'));
                    
                    if (!isNaN(gameIndex) && gameIndex >= 0 && gameIndex < appData.gameHistory.length) {
                        deleteGame(gameIndex);
                    }
                }
                
                // Add player to game button (for admins)
                if (e.target.classList.contains('add-player-to-game')) {
                    const day = e.target.getAttribute('data-day');
                    const selectElement = document.getElementById(`${day}-player-select`);
                    
                    if (day && selectElement && selectElement.value) {
                        const playerId = selectElement.value;
                        addPlayerToGame(day, playerId);
                    }
                }
                
                // Toggle player selector
                if (e.target.classList.contains('toggle-player-selector')) {
                    const day = e.target.getAttribute('data-day');
                    const selector = document.getElementById(`${day}-player-selector`);
                    
                    if (selector) {
                        // Toggle the visibility
                        if (selector.classList.contains('hidden')) {
                            // Hide all other selectors first
                            document.querySelectorAll('.player-selector').forEach(el => {
                                el.classList.add('hidden');
                            });
                            // Show this one
                            selector.classList.remove('hidden');
                        } else {
                            selector.classList.add('hidden');
                        }
                    }
                }
                
                // Select all players button
                if (e.target.classList.contains('select-all-players')) {
                    const day = e.target.getAttribute('data-day');
                    const checkboxes = document.querySelectorAll(`#${day}-player-checkboxes input[type=checkbox]`);
                    
                    // Check all checkboxes
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = true;
                    });
                }
                
                // Add selected players button
                if (e.target.classList.contains('add-selected-players')) {
                    const day = e.target.getAttribute('data-day');
                    const checkboxes = document.querySelectorAll(`#${day}-player-checkboxes input[type=checkbox]:checked`);
                    
                    // Get all selected player IDs
                    const playerIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-player-id'));
                    
                    if (playerIds.length > 0) {
                        // Add all selected players
                        addMultiplePlayersToGame(day, playerIds);
                        
                        // Hide the selector
                        const selector = document.getElementById(`${day}-player-selector`);
                        if (selector) {
                            selector.classList.add('hidden');
                        }
                    } else {
                        alert('No players selected.');
                    }
                }
                
                // Add Players to Current Game button
                if (e.target.id === 'add-players-to-current-game') {
                    // Toggle the player selector visibility
                    const selector = document.getElementById('current-game-player-selector');
                    if (selector) {
                        if (selector.classList.contains('hidden')) {
                            // Show selector and update available players
                            selector.classList.remove('hidden');
                            updateCurrentGamePlayerSelector();
                        } else {
                            selector.classList.add('hidden');
                        }
                    }
                }
                
                // Select all players for current game
                if (e.target.classList.contains('select-all-current-game')) {
                    const checkboxes = document.querySelectorAll('.current-game-player-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = true;
                    });
                }
                
                // Add selected players to current game
                if (e.target.id === 'add-selected-to-current-game') {
                    const checkboxes = document.querySelectorAll('.current-game-player-checkbox:checked');
                    
                    // Get all selected player IDs
                    const playerIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-player-id'));
                    
                    if (playerIds.length > 0) {
                        // Add players to the current game
                        addPlayersToCurrentGame(playerIds);
                        
                        // Hide the selector after adding
                        const selector = document.getElementById('current-game-player-selector');
                        if (selector) {
                            selector.classList.add('hidden');
                        }
                    } else {
                        alert('No players selected.');
                    }
                }
            });
            
            // Book game buttons
            document.querySelectorAll('.book-game').forEach(button => {
                button.addEventListener('click', function() {
                    const day = this.getAttribute('data-day');
                    
                    // Find the current user in the players list
                    const currentPlayer = appData.players.find(p => p.email === currentUser.email);
                    
                    if (!currentPlayer) {
                        alert('You need to be registered as a player to book a seat. Please contact the admin.');
                        return;
                    }
                    
                    // Check if player is already booked
                    if (appData.games[day].players.includes(currentPlayer.id)) {
                        alert('You have already booked a seat for this game.');
                        return;
                    }
                    
                    // Check if this player will be a reserve
                    const isReserve = appData.games[day].players.length >= 10;
                    
                    // If will be a reserve, confirm with the player
                    if (isReserve) {
                        if (!confirm("All regular seats are taken. Do you want to book as a reserve player?")) {
                            return;
                        }
                    }
                    
                    // Add the player directly without showing the modal
                    appData.games[day].players.push(currentPlayer.id);
                    saveData();
                    updateGameSchedule();
                    
                    // Show confirmation message
                    if (isReserve) {
                        alert("You have been added to the game as a reserve player.");
                    } else {
                        alert("Your seat has been booked successfully.");
                    }
                });
            });
            
            // Booking modal buttons
            document.getElementById('cancel-booking').addEventListener('click', function() {
                document.getElementById('booking-modal').classList.remove('active');
            });
            
            document.getElementById('confirm-booking').addEventListener('click', function() {
                const modal = document.getElementById('booking-modal');
                const day = modal.getAttribute('data-day');
                const playerId = document.getElementById('booking-player').value;
                
                if (playerId && day) {
                    // Check if player is already booked
                    if (!appData.games[day].players.includes(playerId)) {
                        appData.games[day].players.push(playerId);
                        saveData();
                        updateGameSchedule();
                    }
                }
                
                modal.classList.remove('active');
            });
            
            // End game button
            document.getElementById('end-game').addEventListener('click', function() {
                if (appData.currentGame) {
                    if (confirm('Are you sure you want to end this game? Make sure all buy-ins and chip counts are recorded.')) {
                        // Make sure the current game has all necessary properties
                        if (!appData.currentGame.buyins) appData.currentGame.buyins = [];
                        if (!appData.currentGame.chips) appData.currentGame.chips = [];
                        if (!appData.currentGame.dealerTips) appData.currentGame.dealerTips = 0;
                        
                        // Make sure we have a date recorded
                        if (!appData.currentGame.date) {
                            appData.currentGame.date = new Date().toISOString().split('T')[0];
                        }
                        
                        // Initialize gameHistory array if it doesn't exist
                        if (!appData.gameHistory) appData.gameHistory = [];
                        
                        // Add a timestamp for when the game ended
                        appData.currentGame.endTime = new Date().toISOString();
                        
                        // Store the current game day before clearing
                        const gameDay = appData.currentGame.day;
                        
                        // Move current game to history
                        appData.gameHistory.push({...appData.currentGame});
                        
                        // Log the game being added to history
                        console.log('Game added to history:', appData.currentGame);
                        console.log('Game history count:', appData.gameHistory.length);
                        
                        // Clear the current game
                        appData.currentGame = null;
                        
                        // Clear the players for this day's game in the schedule
                        if (gameDay && appData.games[gameDay]) {
                            // Reset players array
                            appData.games[gameDay].players = [];
                            
                            // Set the game name to "Coming Soon"
                            appData.games[gameDay].name = "Coming Soon";
                            
                            // Calculate the next date for this day
                            const dayNumber = gameDay === 'monday' ? 1 : (gameDay === 'wednesday' ? 3 : 6);
                            const nextDate = getNextDateForDay(dayNumber);
                            appData.games[gameDay].date = nextDate;
                            
                            console.log(`Cleared players for ${gameDay} game and set name to "Coming Soon"`);
                        }
                        
                        // Save the data
                        saveData();
                        
                        // Update UI
                        updateCurrentGame();
                        updateGameHistory();
                        updateLeaderboard();
                        updateGameSchedule(); // Update the schedule display
                        
                        // Switch to history tab
                        showTab('history');
                        
                        alert('Game ended, saved to history, and schedule cleared!');
                    }
                }
            });
            
            // Help button
            document.getElementById('help-button').addEventListener('click', function() {
                document.getElementById('help-modal').classList.add('active');
            });
            
            document.getElementById('close-help').addEventListener('click', function() {
                document.getElementById('help-modal').classList.remove('active');
            });
            
            // Add player button
            document.getElementById('add-player').addEventListener('click', function() {
                const name = document.getElementById('player-name').value;
                const email = document.getElementById('player-email').value;
                const phone = document.getElementById('player-phone').value;
                
                if (name) {
                    appData.players.push({
                        id: Date.now().toString(),
                        name: name,
                        email: email,
                        phone: phone
                    });
                    
                    // Clear form
                    document.getElementById('player-name').value = '';
                    document.getElementById('player-email').value = '';
                    document.getElementById('player-phone').value = '';
                    
                    saveData();
                    updatePlayerList();
                }
            });
            
            // Save dealer tips button
            document.getElementById('save-tips').addEventListener('click', function(e) {
                e.preventDefault();
                if (!appData.currentGame) return;
                
                const tipsAmount = parseInt(document.getElementById('dealer-tips').value);
                if (!isNaN(tipsAmount)) {
                    // Update the tips in the game data
                    appData.currentGame.dealerTips = tipsAmount;
                    
                    // Show saved amount
                    const savedTipsDisplay = document.getElementById('saved-tips-display');
                    const savedTipsAmount = document.getElementById('saved-tips-amount');
                    savedTipsDisplay.classList.remove('hidden');
                    savedTipsAmount.textContent = tipsAmount;
                    
                    // Calculate and update final balance
                    const totalBuyins = appData.currentGame.buyins.reduce((sum, buyin) => sum + buyin.amount, 0);
                    const totalChips = appData.currentGame.chips.reduce((sum, chip) => sum + chip.amount, 0);
                    const finalBalance = (totalChips + tipsAmount) - totalBuyins;
                    const differenceElement = document.getElementById('total-difference');
                    differenceElement.textContent = '$' + finalBalance;
                    differenceElement.className = `py-2 px-2 sm:px-3 text-right ${finalBalance >= 0 ? 'text-green-600' : 'text-red-600'}`;
                    
                    // Save and update UI
                    saveData();
                    updateUI();
                }
            });
        }

        // Show game results
        function showGameResults(gameIndex) {
            const game = appData.gameHistory[gameIndex];
            const gameDetailsSection = document.getElementById('game-details');
            const historySection = document.querySelector('.bg-white.rounded-lg.shadow-md.p-4.sm\\:p-6.mb-6');
            const resultsTable = document.getElementById('results-table');
            
            if (!gameDetailsSection || !historySection || !resultsTable) return;
            
            // Use the game name if available, otherwise use the capitalized day
            const gameName = game.name || capitalizeFirstLetter(game.day) + ' Game';
            document.getElementById('results-game-name').textContent = gameName;
            document.getElementById('results-game-date').textContent = formatDate(game.date);
            
            resultsTable.innerHTML = '';
            
            // Calculate profit/loss for each player
            game.players.forEach(playerId => {
                const player = appData.players.find(p => p.id === playerId);
                if (!player) return;
                
                // Calculate total buy-ins
                const buyins = game.buyins.filter(b => b.playerId === playerId);
                const totalBuyin = buyins.reduce((sum, b) => sum + b.amount, 0);
                
                // Get end chips
                const chipsRecord = game.chips.find(c => c.playerId === playerId);
                const endChips = chipsRecord ? chipsRecord.amount : 0;
                
                // For cash games, chips equal dollar value (e.g., $200 buy-in = 200 in chips)
                const profitLoss = endChips - totalBuyin;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2 px-2 sm:px-3">${player.name}</td>
                    <td class="py-2 px-2 sm:px-3 text-right">$${totalBuyin}</td>
                    <td class="py-2 px-2 sm:px-3 text-right">$${endChips}</td>
                    <td class="py-2 px-2 sm:px-3 text-right ${profitLoss >= 0 ? 'text-green-600' : 'text-red-600'}">
                        $${profitLoss}
                    </td>
                `;
                resultsTable.appendChild(row);
            });
            
            gameDetailsSection.classList.remove('hidden');
            historySection.classList.add('hidden');
            
            // Set up back button
            document.getElementById('close-results').addEventListener('click', function() {
                gameDetailsSection.classList.add('hidden');
                historySection.classList.remove('hidden');
            });
            
            // Set up share button
            document.getElementById('share-results').addEventListener('click', function() {
                const shareModal = document.getElementById('share-modal');
                shareModal.classList.add('active');
                
                // Generate share link (simple example)
                document.getElementById('share-link').value = window.location.href + '?game=' + gameIndex;
                
                // Populate player dropdown
                const playersSelect = document.getElementById('share-players');
                playersSelect.innerHTML = '';
                
                game.players.forEach(playerId => {
                    const player = appData.players.find(p => p.id === playerId);
                    if (player && player.email) {
                        const option = document.createElement('option');
                        option.value = player.email;
                        option.textContent = player.name;
                        playersSelect.appendChild(option);
                    }
                });
            });
            
            // Close share modal
            document.getElementById('close-share').addEventListener('click', function() {
                document.getElementById('share-modal').classList.remove('active');
            });
            
            // Copy link button
            document.getElementById('copy-link').addEventListener('click', function() {
                const shareLink = document.getElementById('share-link');
                shareLink.select();
                document.execCommand('copy');
                alert('Link copied to clipboard!');
            });
        }
        
        // Helper functions
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }
        
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Add this new function to update the game selector dropdown
        function updateGameSelector() {
            const gameSelector = document.getElementById('game-day');
            if (!gameSelector) return;

            // Save the currently selected value if any
            const currentSelection = gameSelector.value;
            
            // Clear existing options
            gameSelector.innerHTML = '';
            
            // Add options for each game day with the current game name from appData
            ['monday', 'wednesday', 'saturday'].forEach(day => {
                const option = document.createElement('option');
                option.value = day;
                
                // Use the name from appData or fallback to default name
                const gameName = appData.games[day]?.name || (capitalizeFirstLetter(day) + (day === 'saturday' ? ' Afternoon' : ' Night'));
                option.textContent = gameName;
                
                gameSelector.appendChild(option);
            });
            
            // Restore the previously selected value if it exists
            if (currentSelection && gameSelector.querySelector(`option[value="${currentSelection}"]`)) {
                gameSelector.value = currentSelection;
            }
        }

        // Direct function to start a game (called from button onclick)
        function startGame() {
            const day = document.getElementById('game-day').value;
            
            if (day) {
                // Get the game settings from the selected game
                const gameSettings = appData.games[day];
                
                // Create new game with properly initialized arrays and game-specific settings
                appData.currentGame = {
                    date: gameSettings.date,
                    day: day,
                    name: gameSettings.name,
                    players: [...gameSettings.players], // Copy players from schedule
                    buyins: [], // Initialize empty array
                    chips: [], // Initialize empty array
                    dealerTips: 0,
                    // Copy game-specific settings
                    buyinAmount: gameSettings.buyinAmount,
                    startingChips: gameSettings.startingChips,
                    rebuys: gameSettings.rebuys,
                    location: gameSettings.location,
                    notes: gameSettings.notes
                };
                
                saveData();
                
                // Update all necessary UI components
                updateCurrentGame();
                updatePlayerActionsTable();
                updateCurrentGamePlayerSelector(); // Update the player selector for adding more players
                
                // Make sure the player actions section is visible
                const playerActions = document.getElementById('player-actions');
                if (playerActions) {
                    playerActions.classList.remove('hidden');
                }
                
                // Make sure current game info is visible
                const currentGameInfo = document.getElementById('current-game-info');
                if (currentGameInfo) {
                    currentGameInfo.classList.remove('hidden');
                }
                
                // Hide the no current game message
                const noCurrentGame = document.getElementById('no-current-game');
                if (noCurrentGame) {
                    noCurrentGame.classList.add('hidden');
                }
                
                // Switch to game tab
                showTab('game');
                
                console.log("Game started successfully!");
            }
        }

        // Create a new modal for editing individual game details
        function createGameEditModal() {
            // Create the modal element if it doesn't exist
            let modal = document.getElementById('edit-single-game-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'edit-single-game-modal';
                modal.className = 'modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <h2 class="text-xl font-semibold mb-4">Edit Game Details</h2>
                        <input type="hidden" id="edit-game-day">
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-medium mb-2">Game Name</label>
                            <input type="text" id="edit-game-name" class="w-full p-2 border rounded">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-medium mb-2">Game Time</label>
                            <input type="text" id="edit-game-time" class="w-full p-2 border rounded">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-medium mb-2">Game Date</label>
                            <input type="date" id="edit-game-date" class="w-full p-2 border rounded">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-medium mb-2">Buy-in Amount ($)</label>
                            <input type="number" id="edit-game-buyin" class="w-full p-2 border rounded" min="0">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-medium mb-2">Starting Chips</label>
                            <input type="number" id="edit-game-chips" class="w-full p-2 border rounded" min="0">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-medium mb-2">Rebuys</label>
                            <select id="edit-game-rebuys" class="w-full p-2 border rounded">
                                <option value="none">Not Allowed</option>
                                <option value="unlimited">Unlimited</option>
                                <option value="max-1">Maximum 1</option>
                                <option value="max-2">Maximum 2</option>
                                <option value="max-3">Maximum 3</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-medium mb-2">Location</label>
                            <input type="text" id="edit-game-location" class="w-full p-2 border rounded">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-medium mb-2">Notes</label>
                            <textarea id="edit-game-notes" class="w-full p-2 border rounded" rows="3"></textarea>
                        </div>
                        
                        <div class="flex justify-end mt-6">
                            <button id="cancel-edit-game" class="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400 mr-2">Cancel</button>
                            <button id="save-edit-game" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">Save Changes</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Add event listeners - Move this outside the if condition to ensure they're always added
            document.getElementById('cancel-edit-game').addEventListener('click', function() {
                document.getElementById('edit-single-game-modal').classList.remove('active');
            });
            
            document.getElementById('save-edit-game').addEventListener('click', function() {
                console.log("Save button clicked");  // Debug log
                const gameDay = document.getElementById('edit-game-day').value;
                console.log("Game day:", gameDay);  // Debug log
                
                if (gameDay && appData.games[gameDay]) {
                    console.log("Updating game details for:", gameDay);  // Debug log
                    const game = appData.games[gameDay];
                    
                    // Update the game details with form values
                    game.name = document.getElementById('edit-game-name').value;
                    game.time = document.getElementById('edit-game-time').value;
                    game.date = document.getElementById('edit-game-date').value || getNextDateForDay(gameDay === 'monday' ? 1 : (gameDay === 'wednesday' ? 3 : 6));
                    game.buyinAmount = parseInt(document.getElementById('edit-game-buyin').value) || 50;
                    game.startingChips = parseInt(document.getElementById('edit-game-chips').value) || 5000;
                    game.rebuys = document.getElementById('edit-game-rebuys').value;
                    game.location = document.getElementById('edit-game-location').value;
                    game.notes = document.getElementById('edit-game-notes').value;
                    
                    // Save the updated data
                    saveData();
                    
                    // Update the UI
                    updateGameSchedule();
                    
                    // Close the modal
                    document.getElementById('edit-single-game-modal').classList.remove('active');
                    
                    console.log("Game details updated successfully");  // Debug log
                } else {
                    console.error("Error: Invalid game day or game not found");  // Debug log
                }
            });
            
            return modal;
        }

        // Function to add a player to a scheduled game (admin only)
        function addPlayerToGame(day, playerId) {
            if (!isAdmin || !day || !playerId) return;
            
            // Check if the player exists
            const playerExists = appData.players.some(p => p.id === playerId);
            if (!playerExists) return;
            
            // Check if the game exists
            if (!appData.games[day]) return;
            
            // Check if player is already in the game
            if (appData.games[day].players.includes(playerId)) {
                alert("This player is already in the game.");
                return;
            }
            
            // Warn if adding beyond 10 players, but allow it
            if (appData.games[day].players.length >= 10) {
                if (!confirm("This game already has 10 players. Add this player as a reserve?")) {
                    return;
                }
            }
            
            // Add player to the game
            appData.games[day].players.push(playerId);
            
            // Save and update UI
            saveData();
            updateGameSchedule();
            
            // Reset the selection
            const selectElement = document.getElementById(`${day}-player-select`);
            if (selectElement) {
                selectElement.value = "";
            }
        }

        // Function to add multiple players to a scheduled game (admin only)
        function addMultiplePlayersToGame(day, playerIds) {
            if (!isAdmin || !day || !playerIds || !playerIds.length) {
                console.error("Invalid parameters for adding multiple players");
                return;
            }
            
            // Check if the game exists
            if (!appData.games[day]) {
                console.error("Game does not exist:", day);
                return;
            }
            
            // Initialize counters
            let addedCount = 0;
            let alreadyInGameCount = 0;
            let seatsAvailable = 10 - appData.games[day].players.length;
            
            // Process each player
            playerIds.forEach(playerId => {
                // Skip if player doesn't exist
                const playerExists = appData.players.some(p => p.id === playerId);
                if (!playerExists) return;
                
                // Skip if player is already in the game
                if (appData.games[day].players.includes(playerId)) {
                    alreadyInGameCount++;
                    return;
                }
                
                // Skip if no more seats available
                if (seatsAvailable <= 0) return;
                
                // Add player to the game
                appData.games[day].players.push(playerId);
                addedCount++;
                seatsAvailable--;
            });
            
            // Show summary message
            let message = "";
            if (addedCount > 0) {
                message += `Added ${addedCount} player${addedCount !== 1 ? 's' : ''} to the game. `;
                
                if (reserveCount > 0) {
                    message += `(${reserveCount} as reserve${reserveCount !== 1 ? 's' : ''}) `;
                }
            }
            if (alreadyInGameCount > 0) {
                message += `${alreadyInGameCount} player${alreadyInGameCount !== 1 ? 's were' : ' was'} already in the game. `;
            }
            
            if (message) {
                alert(message);
            }
            
            // Save and update UI
            if (addedCount > 0) {
                saveData();
                updateGameSchedule();
            }
        }

        // Function to update the current game player selector
        function updateCurrentGamePlayerSelector() {
            const checkboxContainer = document.getElementById('current-game-player-checkboxes');
            if (!checkboxContainer || !appData.currentGame) return;
            
            // Clear existing checkboxes
            checkboxContainer.innerHTML = '';
            
            // Get players already in this game
            const gamePlayers = appData.currentGame.players || [];
            
            if (appData.players.length === 0) {
                // No players exist yet
                checkboxContainer.innerHTML = '<p class="text-sm text-gray-500">No players available. Add players in the Players tab first.</p>';
                return;
            }
            
            let availablePlayersCount = 0;
            
            // Add a checkbox for each player who is not already in the game
            appData.players.forEach(player => {
                // Check if player is already in the game
                const isInGame = gamePlayers.includes(player.id);
                
                // Only show players not in the game
                if (!isInGame) {
                    availablePlayersCount++;
                    
                    const checkboxItem = document.createElement('div');
                    checkboxItem.className = 'flex items-center';
                    
                    // Check if player would be a reserve (over 10 players)
                    const wouldBeReserve = gamePlayers.length >= 10;
                    
                    checkboxItem.innerHTML = `
                        <input type="checkbox" id="current-game-player-${player.id}" 
                            class="current-game-player-checkbox mr-2" 
                            data-player-id="${player.id}">
                        <label for="current-game-player-${player.id}" class="text-sm">
                            ${player.name}${wouldBeReserve ? ' <span class="text-xs text-amber-600">(will be reserve)</span>' : ''}
                        </label>
                    `;
                    
                    checkboxContainer.appendChild(checkboxItem);
                }
            });
            
            // Show message if no available players
            if (availablePlayersCount === 0) {
                checkboxContainer.innerHTML = '<p class="text-sm text-gray-500">All players are already in this game.</p>';
            }
        }
        
        // Function to add multiple players to the current game
        function addPlayersToCurrentGame(playerIds) {
            if (!isAdmin || !appData.currentGame || !playerIds || !playerIds.length) {
                console.error("Invalid parameters for adding players to current game");
                return;
            }
            
            // Initialize counters
            let addedCount = 0;
            let reserveCount = 0;
            let alreadyInGameCount = 0;
            const currentPlayerCount = appData.currentGame.players.length;
            
            // Process each player
            playerIds.forEach(playerId => {
                // Skip if player doesn't exist
                const playerExists = appData.players.some(p => p.id === playerId);
                if (!playerExists) return;
                
                // Skip if player is already in the game
                if (appData.currentGame.players.includes(playerId)) {
                    alreadyInGameCount++;
                    return;
                }
                
                // Track if this player will be a reserve
                const willBeReserve = currentPlayerCount + addedCount >= 10;
                if (willBeReserve) {
                    reserveCount++;
                }
                
                // Add player to the game (no limit)
                appData.currentGame.players.push(playerId);
                addedCount++;
            });
            
            // Show summary message
            let message = "";
            if (addedCount > 0) {
                message += `Added ${addedCount} player${addedCount !== 1 ? 's' : ''} to the game. `;
                
                if (reserveCount > 0) {
                    message += `(${reserveCount} as reserve${reserveCount !== 1 ? 's' : ''}) `;
                }
            }
            if (alreadyInGameCount > 0) {
                message += `${alreadyInGameCount} player${alreadyInGameCount !== 1 ? 's were' : ' was'} already in the game. `;
            }
            
            if (message) {
                alert(message);
            }
            
            // Save and update UI
            if (addedCount > 0) {
                saveData();
                updateCurrentGame();
                updatePlayerActionsTable();
                updateCurrentGamePlayerSelector();
            }
        }

        // Function to delete a game from history (admin only)
        function deleteGame(gameIndex) {
            if (!isAdmin) {
                alert("Only administrators can delete games.");
                return;
            }
            
            if (gameIndex < 0 || gameIndex >= appData.gameHistory.length) {
                console.error("Invalid game index:", gameIndex);
                return;
            }
            
            // Ask for confirmation before deleting
            if (confirm("Are you sure you want to delete this game? This action cannot be undone.")) {
                // Get the game to be deleted (for logging purposes)
                const gameToDelete = appData.gameHistory[gameIndex];
                console.log("Deleting game:", gameToDelete);
                
                // Remove the game from the history array
                appData.gameHistory.splice(gameIndex, 1);
                
                // Save the data
                saveData();
                
                // Update the UI
                updateGameHistory();
                updateLeaderboard(); // Update leaderboard as game stats have changed
                
                console.log("Game deleted successfully");
                alert("Game deleted successfully");
            }
        }
    </script>
    
    <!-- Fix for the Save Changes button not working -->
    <script>
        // Wait for the page to load completely
        window.addEventListener('load', function() {
            // Make sure the modal and button exist
            setTimeout(function() {
                // Fix for the edit-single-game-modal
                const saveButton = document.getElementById('save-edit-game');
                if (saveButton) {
                    console.log("Found save button, attaching new handler");
                    
                    // Add a direct click handler
                    saveButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log("Save button clicked");
                        
                        const gameDay = document.getElementById('edit-game-day').value;
                        console.log("Updating game for day:", gameDay);
                        
                        if (gameDay && appData.games[gameDay]) {
                            const game = appData.games[gameDay];
                            
                            // Update the game details with form values
                            game.name = document.getElementById('edit-game-name').value;
                            game.time = document.getElementById('edit-game-time').value;
                            game.date = document.getElementById('edit-game-date').value || getNextDateForDay(gameDay === 'monday' ? 1 : (gameDay === 'wednesday' ? 3 : 6));
                            game.buyinAmount = parseInt(document.getElementById('edit-game-buyin').value) || 50;
                            game.startingChips = parseInt(document.getElementById('edit-game-chips').value) || 5000;
                            game.rebuys = document.getElementById('edit-game-rebuys').value;
                            game.location = document.getElementById('edit-game-location').value;
                            game.notes = document.getElementById('edit-game-notes').value;
                            
                            // Save the updated data
                            saveData();
                            
                            // Update the UI
                            updateGameSchedule();
                            
                            // Close the modal
                            document.getElementById('edit-single-game-modal').classList.remove('active');
                            
                            console.log("Game details updated successfully");
                        } else {
                            console.error("Error: Invalid game day or game not found");
                            alert("Error: Could not save game details. Please try again.");
                        }
                    });
                    
                    console.log("New handler attached to save button");
                }
                
                // Also fix the cancel button
                const cancelButton = document.getElementById('cancel-edit-game');
                if (cancelButton) {
                    cancelButton.addEventListener('click', function() {
                        document.getElementById('edit-single-game-modal').classList.remove('active');
                    });
                }
                
                // Ensure the edit buttons work
                document.querySelectorAll('.edit-game-details').forEach(button => {
                    button.addEventListener('click', function() {
                        const gameDay = this.getAttribute('data-day');
                        console.log("Edit button clicked for:", gameDay);
                        
                        if (gameDay && appData.games[gameDay]) {
                            const game = appData.games[gameDay];
                            const modal = document.getElementById('edit-single-game-modal');
                            
                            // Set the hidden game day field
                            document.getElementById('edit-game-day').value = gameDay;
                            
                            // Populate form fields with current game values
                            document.getElementById('edit-game-name').value = game.name || '';
                            document.getElementById('edit-game-time').value = game.time || '';
                            document.getElementById('edit-game-date').value = game.date || '';
                            document.getElementById('edit-game-buyin').value = game.buyinAmount || 50;
                            document.getElementById('edit-game-chips').value = game.startingChips || 5000;
                            document.getElementById('edit-game-rebuys').value = game.rebuys || 'none';
                            document.getElementById('edit-game-location').value = game.location || '';
                            document.getElementById('edit-game-notes').value = game.notes || '';
                            
                            // Open the modal
                            modal.classList.add('active');
                        }
                    });
                });
            }, 1000); // Small delay to ensure DOM is fully loaded
        });
    </script>
</body>
</html>
